<?php
/**
 * Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ ÏÉÅÌíà ÌÇ§ÏõåÎìú Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨Í∏∞ (4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÖúÌîåÎ¶ø ÏãúÏä§ÌÖú ÏßÄÏõê)
 * affiliate_editor.phpÏóêÏÑú POSTÎ°ú Ï†ÑÏÜ°Îêú Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨ÌïòÍ≥† ÌÅê ÌååÏùºÏóê Ï†ÄÏû•Ìï©ÎãàÎã§.
 * ÏõåÎìúÌîÑÎ†àÏä§ ÌôòÍ≤ΩÏóê Ï†ÑÌòÄ Ï¢ÖÏÜçÎêòÏßÄ ÏïäÏúºÎ©∞, ÏàúÏàò PHPÎ°úÎßå ÏûëÎèôÌï©ÎãàÎã§.
 *
 * ÌååÏùº ÏúÑÏπò: /var/www/novacents/tools/keyword_processor.php
 * Î≤ÑÏ†Ñ: v3.0 (4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÖúÌîåÎ¶ø ÏãúÏä§ÌÖú ÏßÄÏõê)
 */

// 1. Ï¥àÍ∏∞ ÏóêÎü¨ Î¶¨Ìè¨ÌåÖ ÏÑ§Ï†ï (Ïä§ÌÅ¨Î¶ΩÌä∏ ÏãúÏûë ÏãúÏ†êÎ∂ÄÌÑ∞ ÏóêÎü¨Î•º Ïû°Í∏∞ ÏúÑÌï®)
error_reporting(E_ALL); // Î™®Îì† PHP ÏóêÎü¨Î•º Î≥¥Í≥†
ini_set('display_errors', 1); // Ïõπ Î∏åÎùºÏö∞Ï†ÄÏóê ÏóêÎü¨Î•º ÏßÅÏ†ë ÌëúÏãú
ini_set('log_errors', 1); // ÏóêÎü¨Î•º Ïõπ ÏÑúÎ≤Ñ ÏóêÎü¨ Î°úÍ∑∏Ïóê Í∏∞Î°ù
ini_set('error_log', __DIR__ . '/php_error_log.txt'); // PHP ÏóêÎü¨Î•º ÌäπÏ†ï ÌååÏùºÏóê Í∏∞Î°ù

// 2. ÌååÏùº Í≤ΩÎ°ú ÏÉÅÏàò Ï†ïÏùò (ÌïúÍ≥≥ÏóêÏÑú Í¥ÄÎ¶¨)
define('BASE_PATH', __DIR__); // ÌòÑÏû¨ ÌååÏùºÏù¥ ÏûàÎäî ÎîîÎ†âÌÜ†Î¶¨
define('ENV_FILE', '/home/novacents/.env'); // .env ÌååÏùºÏùÄ Ìôà ÎîîÎ†âÌÜ†Î¶¨Ïóê Í≥†Ï†ï
define('DEBUG_LOG_FILE', BASE_PATH . '/debug_processor.txt');
define('MAIN_LOG_FILE', BASE_PATH . '/processor_log.txt');
define('QUEUE_FILE', BASE_PATH . '/product_queue.json');

// 3. ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏ Ìï®Ïàò (Ïä§ÌÅ¨Î¶ΩÌä∏ ÏãúÏûëÎ∂ÄÌÑ∞ ÎÅùÍπåÏßÄ Î™®Îì† ÌùêÎ¶Ñ Í∏∞Î°ù)
function debug_log($message) {
    $timestamp = date('Y-m-d H:i:s');
    $log_entry = "[{$timestamp}] DEBUG: {$message}\n";
    @file_put_contents(DEBUG_LOG_FILE, $log_entry, FILE_APPEND | LOCK_EX); // @ suppress errors
}

// Ïä§ÌÅ¨Î¶ΩÌä∏ ÏãúÏûë Ïãú Ï¶âÏãú ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Í∏∞Î°ù
debug_log("=== keyword_processor.php ÏãúÏûë (4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÖúÌîåÎ¶ø ÏãúÏä§ÌÖú ÏßÄÏõê Î≤ÑÏ†Ñ) ===");
debug_log("PHP Version: " . phpversion());
debug_log("Request Method: " . ($_SERVER['REQUEST_METHOD'] ?? 'N/A'));
debug_log("POST Data Empty: " . (empty($_POST) ? 'YES' : 'NO'));
debug_log("Script Path: " . __FILE__);
debug_log("Base Path: " . BASE_PATH);


// 4. ÌôòÍ≤Ω Î≥ÄÏàò Î°úÎìú Ìï®Ïàò (ÏõåÎìúÌîÑÎ†àÏä§ Ïô∏Î∂ÄÏóêÏÑú .env ÌååÏùºÏùÑ ÏïàÏ†ÑÌïòÍ≤å Î°úÎìú)
function load_env_variables() {
    debug_log("load_env_variables: Loading environment variables from " . ENV_FILE);
    $env_vars = [];
    if (!file_exists(ENV_FILE)) {
        debug_log("load_env_variables: .env file not found at " . ENV_FILE);
        return $env_vars;
    }

    try {
        $lines = file(ENV_FILE, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        if ($lines === false) {
            debug_log("load_env_variables: Failed to read .env file content.");
            return $env_vars;
        }
        foreach ($lines as $line) {
            $line = trim($line);
            if (strpos($line, '#') === 0 || empty($line)) {
                continue; // Skip comments and empty lines
            }
            if (strpos($line, '=') !== false) {
                list($key, $value) = explode('=', $line, 2);
                $env_vars[trim($key)] = trim($value);
            }
        }
        debug_log("load_env_variables: Successfully loaded " . count($env_vars) . " variables.");
    } catch (Exception $e) {
        debug_log("load_env_variables: Exception while reading .env file: " . $e->getMessage());
    }
    return $env_vars;
}


// 5. ÏùºÎ∞ò Î°úÍ∑∏ Ìï®Ïàò (Ï£ºÏöî ÏûëÏóÖ ÌùêÎ¶Ñ Í∏∞Î°ù)
function main_log($message) {
    $timestamp = date('Y-m-d H:i:s');
    $log_entry = "[{$timestamp}] INFO: {$message}\n";
    @file_put_contents(MAIN_LOG_FILE, $log_entry, FILE_APPEND | LOCK_EX);
}


// 6. ÏûÖÎ†•Í∞í ÏïàÏ†Ñ Ï≤òÎ¶¨ Ìï®Ïàò (htmlspecialchars, strip_tags Îì± ÏÇ¨Ïö©)
function clean_input($data) {
    $data = trim($data);
    $data = stripslashes($data); // Îß§ÏßÅ ÏøºÌä∏ Ï†úÍ±∞ (PHP ÏÑ§Ï†ïÏóê Îî∞Îùº Îã§Î¶Ñ)
    $data = htmlspecialchars($data, ENT_QUOTES, 'UTF-8'); // HTML ÌäπÏàò Î¨∏Ïûê Î≥ÄÌôò
    $data = strip_tags($data); // HTML ÌÉúÍ∑∏ Ï†úÍ±∞
    return $data;
}


// 7. ÌÖîÎ†àÍ∑∏Îû® ÏïåÎ¶º Î∞úÏÜ° Ìï®Ïàò (cURL Ïö∞ÏÑ†, file_get_contents Î∞±ÏóÖ)
function send_telegram_notification($message, $urgent = false) {
    debug_log("send_telegram_notification: Attempting to send message.");
    $env_vars = load_env_variables();
    $bot_token = $env_vars['TELEGRAM_BOT_TOKEN'] ?? '';
    $chat_id = $env_vars['TELEGRAM_CHAT_ID'] ?? '';

    if (empty($bot_token) || empty($chat_id)) {
        debug_log("send_telegram_notification: TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set in .env.");
        return false;
    }

    $final_message = $urgent ? "üö® Í∏¥Í∏â ÏïåÎ¶º üö®\n\n" : "ü§ñ ÎÖ∏Î∞îÏÑºÌä∏ Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ Î¥á\n\n";
    $final_message .= $message;

    $url = "https://api.telegram.org/bot{$bot_token}/sendMessage";
    $data = [
        'chat_id' => $chat_id,
        'text' => $final_message,
        'parse_mode' => 'HTML'
    ];

    $response_content = null;
    $http_code = 0;
    $success = false;

    // Try cURL first
    if (function_exists('curl_init')) {
        debug_log("send_telegram_notification: Using cURL.");
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 15);
        $response_content = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $curl_error = curl_error($ch);
        curl_close($ch);

        debug_log("send_telegram_notification: cURL Result - HTTP: {$http_code}, Error: {$curl_error}, Response: " . substr($response_content, 0, 200));

        if ($http_code === 200 && $response_content !== false) {
            $json_response = json_decode($response_content, true);
            if (isset($json_response['ok']) && $json_response['ok'] === true) {
                $success = true;
            }
        }
    }

    // Fallback to file_get_contents if cURL failed or not available
    if (!$success && ini_get('allow_url_fopen')) {
        debug_log("send_telegram_notification: Using file_get_contents.");
        $options = [
            'http' => [
                'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
                'method'  => 'POST',
                'content' => http_build_query($data),
                'timeout' => 15,
                'ignore_errors' => true // Allows reading response even for HTTP error codes
            ]
        ];
        $context = stream_context_create($options);
        $response_content = @file_get_contents($url, false, $context); // @ to suppress warnings
        
        // Check HTTP response header from stream context
        if (isset($http_response_header)) { // This variable is automatically set by file_get_contents
            preg_match('{HTTP/\S+\s(\d{3})}', $http_response_header[0], $match);
            $http_code = (int)$match[1];
        }

        debug_log("send_telegram_notification: file_get_contents Result - HTTP: {$http_code}, Response: " . substr($response_content, 0, 200));

        if ($http_code === 200 && $response_content !== false) {
            $json_response = json_decode($response_content, true);
            if (isset($json_response['ok']) && $json_response['ok'] === true) {
                $success = true;
            }
        }
    }

    if ($success) {
        debug_log("send_telegram_notification: Message sent successfully.");
    } else {
        debug_log("send_telegram_notification: Failed to send message through all methods.");
    }
    return $success;
}


// 8. ÌÅê ÌååÏùº Î°úÎìú/Ï†ÄÏû•/Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
function get_queue_file_path() {
    return QUEUE_FILE;
}

function load_queue() {
    $queue_file = get_queue_file_path();
    debug_log("load_queue: Attempting to load queue from " . $queue_file);

    if (!file_exists($queue_file)) {
        debug_log("load_queue: Queue file does not exist. Returning empty array.");
        return [];
    }

    $content = @file_get_contents($queue_file); // @ to suppress warnings/errors on read failure
    if ($content === false) {
        debug_log("load_queue: Failed to read queue file content.");
        return [];
    }
    
    // ÌååÏùº ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÎäî Í≤ΩÏö∞ Îπà Î∞∞Ïó¥ Î∞òÌôò
    if (trim($content) === '') {
        debug_log("load_queue: Queue file is empty. Returning empty array.");
        return [];
    }

    $queue = json_decode($content, true);
    if (json_last_error() !== JSON_ERROR_NONE) {
        debug_log("load_queue: JSON decoding error: " . json_last_error_msg() . ". Content: " . substr($content, 0, 200));
        return []; // Decoding failed, return empty array
    }
    
    $result = is_array($queue) ? $queue : [];
    debug_log("load_queue: Successfully loaded " . count($result) . " items from queue.");
    return $result;
}

function save_queue($queue) {
    $queue_file = get_queue_file_path();
    debug_log("save_queue: Attempting to save " . count($queue) . " items to " . $queue_file);

    // Use numerical values for JSON options to avoid potential parsing issues
    $json_options = 128 | 256 | 64; // JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES
    $json_data = json_encode($queue, $json_options);

    if ($json_data === false) {
        debug_log("save_queue: JSON encoding failed: " . json_last_error_msg());
        return false;
    }

    // Attempt to write the file with error handling
    if (@file_put_contents($queue_file, $json_data, LOCK_EX) === false) { // @ suppress errors
        $error = error_get_last();
        debug_log("save_queue: Failed to write to queue file: " . ($error['message'] ?? 'Unknown error') . ". Check file permissions.");
        return false;
    }

    debug_log("save_queue: Successfully saved queue to " . $queue_file);
    return true;
}

function add_to_queue($queue_data) {
    debug_log("add_to_queue: Adding new item to queue.");
    $queue = load_queue();
    $queue[] = $queue_data;
    return save_queue($queue);
}

function get_queue_stats() {
    debug_log("get_queue_stats: Calculating queue statistics.");
    $queue = load_queue();
    $stats = [
        'total' => count($queue),
        'pending' => 0, 'processing' => 0,
        'completed' => 0, 'failed' => 0
    ];
    foreach ($queue as $item) {
        $status = $item['status'] ?? 'pending';
        if (isset($stats[$status])) {
            $stats[$status]++;
        }
    }
    debug_log("get_queue_stats: Statistics: " . json_encode($stats));
    return $stats;
}


// 9. Î¶¨Îã§Ïù¥Î†âÏÖò Ìï®Ïàò (ÏÑ±Í≥µ/Ïã§Ìå® Î©îÏãúÏßÄ Ï†ÑÎã¨)
function redirect_to_editor($success, $message_params) {
    $base_url = 'affiliate_editor.php';
    $query_string = http_build_query($message_params);
    $location = $base_url . '?' . $query_string;
    debug_log("redirect_to_editor: Redirecting to {$location}");
    header("Location: {$location}");
    exit;
}


// 10. Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ìïë Ìï®Ïàò
function get_category_name($category_id) {
    $categories = [
        '354' => 'Today\'s Pick',
        '355' => 'Í∏∞Î∞úÌïú Ïû°ÌôîÏ†ê',
        '356' => 'Ïä§ÎßàÌä∏ Î¶¨Îπô',
        '12' => 'Ïö∞Î¶¨ÏûáÌÖú'
    ];
    return $categories[$category_id] ?? 'Ïïå Ïàò ÏóÜÎäî Ïπ¥ÌÖåÍ≥†Î¶¨';
}

// üöÄ 11. ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ Í¥ÄÎ†® Ìï®ÏàòÎì§ (ÏÉàÎ°ú Ï∂îÍ∞Ä)
function get_prompt_type_name($prompt_type) {
    $prompt_types = [
        'essential_items' => 'ÌïÑÏàòÌÖúÌòï üéØ',
        'friend_review' => 'ÏπúÍµ¨ Ï∂îÏ≤úÌòï üë´',
        'professional_analysis' => 'Ï†ÑÎ¨∏ Î∂ÑÏÑùÌòï üìä',
        'amazing_discovery' => 'ÎÜÄÎùºÏõÄ Î∞úÍ≤¨Ìòï ‚ú®'
    ];
    return $prompt_types[$prompt_type] ?? 'Í∏∞Î≥∏Ìòï';
}

function validate_prompt_type($prompt_type) {
    $valid_prompt_types = ['essential_items', 'friend_review', 'professional_analysis', 'amazing_discovery'];
    return in_array($prompt_type, $valid_prompt_types);
}

// 12. ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï≤òÎ¶¨ Ìï®ÏàòÎì§
function parse_user_details($user_details_json) {
    debug_log("parse_user_details: Parsing user details JSON.");
    
    if (empty($user_details_json)) {
        debug_log("parse_user_details: Empty user details JSON provided.");
        return null;
    }
    
    try {
        $user_details = json_decode($user_details_json, true);
        if (json_last_error() !== JSON_ERROR_NONE) {
            debug_log("parse_user_details: JSON parsing error: " . json_last_error_msg());
            return null;
        }
        
        debug_log("parse_user_details: Successfully parsed user details with " . count($user_details) . " sections.");
        return $user_details;
        
    } catch (Exception $e) {
        debug_log("parse_user_details: Exception while parsing user details: " . $e->getMessage());
        return null;
    }
}

function validate_user_details($user_details) {
    debug_log("validate_user_details: Validating user details structure.");
    
    if (!is_array($user_details)) {
        debug_log("validate_user_details: User details is not an array.");
        return false;
    }
    
    $allowed_sections = ['specs', 'efficiency', 'usage', 'benefits'];
    $valid_sections = 0;
    
    foreach ($user_details as $section_name => $section_data) {
        if (in_array($section_name, $allowed_sections) && is_array($section_data)) {
            $valid_sections++;
            debug_log("validate_user_details: Valid section found: {$section_name} with " . count($section_data) . " fields.");
        } else {
            debug_log("validate_user_details: Invalid or unknown section: {$section_name}");
        }
    }
    
    debug_log("validate_user_details: Found {$valid_sections} valid sections out of " . count($user_details) . " total sections.");
    return $valid_sections > 0; // ÏµúÏÜå ÌïòÎÇòÏùò Ïú†Ìö®Ìïú ÏÑπÏÖòÏù¥ ÏûàÏúºÎ©¥ ÌÜµÍ≥º
}

function format_user_details_summary($user_details) {
    $summary = [];
    
    if (isset($user_details['specs']) && is_array($user_details['specs'])) {
        $specs_count = count($user_details['specs']);
        $summary[] = "Í∏∞Îä•/Ïä§Ìéô: {$specs_count}Í∞ú Ìï≠Î™©";
    }
    
    if (isset($user_details['efficiency']) && is_array($user_details['efficiency'])) {
        $efficiency_count = count($user_details['efficiency']);
        $summary[] = "Ìö®Ïú®ÏÑ± Î∂ÑÏÑù: {$efficiency_count}Í∞ú Ìï≠Î™©";
    }
    
    if (isset($user_details['usage']) && is_array($user_details['usage'])) {
        $usage_count = count($user_details['usage']);
        $summary[] = "ÏÇ¨Ïö© ÏãúÎÇòÎ¶¨Ïò§: {$usage_count}Í∞ú Ìï≠Î™©";
    }
    
    if (isset($user_details['benefits']) && is_array($user_details['benefits'])) {
        $benefits_count = 0;
        if (isset($user_details['benefits']['advantages']) && is_array($user_details['benefits']['advantages'])) {
            $benefits_count += count($user_details['benefits']['advantages']);
        }
        if (isset($user_details['benefits']['precautions'])) {
            $benefits_count += 1;
        }
        $summary[] = "Ïû•Ï†ê/Ï£ºÏùòÏÇ¨Ìï≠: {$benefits_count}Í∞ú Ìï≠Î™©";
    }
    
    return implode(', ', $summary);
}


// 13. ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Î∞è Ï†ïÎ¶¨ Ìï®Ïàò (ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ ÏßÄÏõê Ï∂îÍ∞Ä)
function validate_input_data($data) {
    debug_log("validate_input_data: Starting validation with prompt type and user details support.");
    $errors = [];

    if (empty($data['title']) || strlen(trim($data['title'])) < 5) {
        $errors[] = 'Ï†úÎ™©ÏùÄ 5Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.';
    }
    
    $valid_categories = ['354', '355', '356', '12'];
    if (empty($data['category']) || !in_array((int)$data['category'], $valid_categories)) {
        $errors[] = 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïπ¥ÌÖåÍ≥†Î¶¨ÏûÖÎãàÎã§.';
    }

    // üöÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ Í≤ÄÏ¶ù Ï∂îÍ∞Ä
    if (empty($data['prompt_type']) || !validate_prompt_type($data['prompt_type'])) {
        $errors[] = 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖÏûÖÎãàÎã§.';
    }

    if (empty($data['keywords']) || !is_array($data['keywords'])) {
        $errors[] = 'ÏµúÏÜå ÌïòÎÇòÏùò ÌÇ§ÏõåÎìúÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.';
    } else {
        foreach ($data['keywords'] as $index => $keyword_item) {
            if (empty($keyword_item['name']) || strlen(trim($keyword_item['name'])) < 2) {
                $errors[] = "ÌÇ§ÏõåÎìú #" . ($index + 1) . "Ïùò Ïù¥Î¶ÑÏù¥ ÎÑàÎ¨¥ ÏßßÏäµÎãàÎã§.";
            }

            $has_valid_link = false;
            if (!empty($keyword_item['coupang']) && is_array($keyword_item['coupang'])) {
                foreach ($keyword_item['coupang'] as $link) {
                    if (!empty($link) && filter_var(trim($link), FILTER_VALIDATE_URL)) {
                        $has_valid_link = true;
                        break;
                    }
                }
                if (count($keyword_item['coupang']) > 10) {
                    $errors[] = "ÌÇ§ÏõåÎìú '" . clean_input($keyword_item['name'] ?? '') . "'Ïùò Ïø†Ìå° ÎßÅÌÅ¨Îäî ÏµúÎåÄ 10Í∞úÍπåÏßÄ ÌóàÏö©Îê©ÎãàÎã§.";
                }
            }
            
            if (!empty($keyword_item['aliexpress']) && is_array($keyword_item['aliexpress'])) {
                foreach ($keyword_item['aliexpress'] as $link) {
                    if (!empty($link) && filter_var(trim($link), FILTER_VALIDATE_URL)) {
                        $has_valid_link = true;
                        break;
                    }
                }
            }

            if (!$has_valid_link) {
                $errors[] = "ÌÇ§ÏõåÎìú '" . clean_input($keyword_item['name'] ?? '') . "'Ïóê Ïú†Ìö®Ìïú ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä ÏóÜÏäµÎãàÎã§.";
            }
        }
    }
    
    // ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í≤ÄÏ¶ù (ÏÑ†ÌÉùÏÇ¨Ìï≠Ïù¥ÎØÄÎ°ú Ïò§Î•òÎäî ÏïÑÎãò)
    if (!empty($data['user_details'])) {
        $user_details = parse_user_details($data['user_details']);
        if ($user_details !== null && !validate_user_details($user_details)) {
            debug_log("validate_input_data: User details validation failed, but continuing as it's optional.");
            // Ïò§Î•òÎ°ú Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå - ÏÑ†ÌÉùÏÇ¨Ìï≠Ïù¥ÎØÄÎ°ú
        }
    }
    
    debug_log("validate_input_data: Validation finished with " . count($errors) . " errors.");
    return $errors;
}

function clean_affiliate_links($keywords_raw) {
    debug_log("clean_affiliate_links: Starting link cleaning.");
    $cleaned_keywords = [];
    foreach ($keywords_raw as $index => $keyword_item) {
        $cleaned_item = [
            'name' => clean_input($keyword_item['name'] ?? ''),
            'coupang' => [],
            'aliexpress' => []
        ];

        // Clean Coupang links
        if (!empty($keyword_item['coupang']) && is_array($keyword_item['coupang'])) {
            foreach ($keyword_item['coupang'] as $link) {
                $link = trim($link);
                if (!empty($link) && filter_var($link, FILTER_VALIDATE_URL)) {
                    $cleaned_item['coupang'][] = $link;
                }
            }
        }

        // Clean AliExpress links
        if (!empty($keyword_item['aliexpress']) && is_array($keyword_item['aliexpress'])) {
            foreach ($keyword_item['aliexpress'] as $link) {
                $link = trim($link);
                if (!empty($link) && filter_var($link, FILTER_VALIDATE_URL)) {
                    $cleaned_item['aliexpress'][] = $link;
                }
            }
        }

        // Only add if keyword name is not empty and has at least one valid link
        if (!empty($cleaned_item['name']) && (!empty($cleaned_item['coupang']) || !empty($cleaned_item['aliexpress']))) {
            $cleaned_keywords[] = $cleaned_item;
        } else {
            debug_log("clean_affiliate_links: Keyword '" . ($keyword_item['name'] ?? 'N/A') . "' (index {$index}) removed due to empty name or no valid links.");
        }
    }
    debug_log("clean_affiliate_links: Finished cleaning. " . count($cleaned_keywords) . " keywords remain.");
    return $cleaned_keywords;
}


// 14. Î©îÏù∏ Ï≤òÎ¶¨ Î°úÏßÅ (4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÖúÌîåÎ¶ø ÏãúÏä§ÌÖú ÏßÄÏõê)
function main_process() {
    debug_log("main_process: Main processing started with 4-prompt template system support.");

    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        debug_log("main_process: Invalid request method. Not a POST request.");
        redirect_to_editor(false, ['error' => 'ÏûòÎ™ªÎêú ÏöîÏ≤≠ Î∞©ÏãùÏûÖÎãàÎã§. POST Î©îÏÑúÎìúÎßå ÌóàÏö©Îê©ÎãàÎã§.']);
    }

    // Input data collection (ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ + ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ìè¨Ìï®)
    $input_data = [
        'title' => clean_input($_POST['title'] ?? ''),
        'category' => clean_input($_POST['category'] ?? ''),
        'prompt_type' => clean_input($_POST['prompt_type'] ?? 'essential_items'), // üöÄ ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ
        'keywords' => $_POST['keywords'] ?? [],
        'user_details' => $_POST['user_details'] ?? null
    ];
    
    debug_log("main_process: Input data collected: " . json_encode($input_data, JSON_UNESCAPED_UNICODE));
    main_log("Input data received: Title='" . $input_data['title'] . "', Category=" . $input_data['category'] . ", Prompt Type=" . $input_data['prompt_type'] . ", Keywords=" . count($input_data['keywords']) . ", User Details=" . (empty($input_data['user_details']) ? 'No' : 'Yes') . ".");

    // Data validation
    $validation_errors = validate_input_data($input_data);
    if (!empty($validation_errors)) {
        debug_log("main_process: Validation failed. Errors: " . implode(' | ', $validation_errors));
        $telegram_msg = "‚ùå Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ïã§Ìå®:\n\n" . implode("\n‚Ä¢ ", $validation_errors) . "\n\nÏûÖÎ†•Îêú Îç∞Ïù¥ÌÑ∞:\nÏ†úÎ™©: " . $input_data['title'] . "\nÏπ¥ÌÖåÍ≥†Î¶¨: " . get_category_name($input_data['category']) . "\nÌîÑÎ°¨ÌîÑÌä∏: " . get_prompt_type_name($input_data['prompt_type']) . "\nÌÇ§ÏõåÎìú Ïàò: " . count($input_data['keywords']) . "Í∞ú";
        send_telegram_notification($telegram_msg, true);
        main_log("Data validation failed: " . implode(', ', $validation_errors));
        redirect_to_editor(false, ['error' => 'Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Ïò§Î•ò: ' . implode(' | ', $validation_errors)]);
    }
    debug_log("main_process: Data validation passed.");

    // Clean product links (ÏùºÎ∞ò ÏÉÅÌíà ÎßÅÌÅ¨)
    $cleaned_keywords = clean_affiliate_links($input_data['keywords']);
    if (empty($cleaned_keywords)) {
        debug_log("main_process: No valid keywords with links after cleaning.");
        $telegram_msg = "‚ùå Ïú†Ìö®Ìïú ÌÇ§ÏõåÎìú Î∞è ÎßÅÌÅ¨ ÏóÜÏùå:\nÏú†Ìö®Ìïú ÌÇ§ÏõåÎìúÏôÄ ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä ÏóÜÏñ¥ÏÑú ÏûëÏóÖÏùÑ ÏßÑÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§.";
        send_telegram_notification($telegram_msg, true);
        main_log("No valid keywords or links found after cleaning.");
        redirect_to_editor(false, ['error' => 'Ïú†Ìö®Ìïú ÌÇ§ÏõåÎìú Î∞è ÏÉÅÌíà ÎßÅÌÅ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.']);
    }
    debug_log("main_process: Product links cleaned. " . count($cleaned_keywords) . " keywords remain.");

    // ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï≤òÎ¶¨
    $user_details_data = null;
    if (!empty($input_data['user_details'])) {
        $user_details_data = parse_user_details($input_data['user_details']);
        if ($user_details_data !== null && validate_user_details($user_details_data)) {
            debug_log("main_process: User details successfully processed: " . format_user_details_summary($user_details_data));
        } else {
            debug_log("main_process: User details provided but failed validation. Continuing without user details.");
            $user_details_data = null;
        }
    } else {
        debug_log("main_process: No user details provided.");
    }

    // Create queue data structure (ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ + ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ìè¨Ìï®)
    $queue_data = [
        'queue_id' => date('YmdHis') . '_' . random_int(10000, 99999), // Unique ID
        'title' => $input_data['title'],
        'category_id' => (int)$input_data['category'],
        'category_name' => get_category_name((int)$input_data['category']),
        'prompt_type' => $input_data['prompt_type'], // üöÄ ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ
        'prompt_type_name' => get_prompt_type_name($input_data['prompt_type']), // üöÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖÎ™Ö
        'keywords' => $cleaned_keywords,
        'user_details' => $user_details_data,
        'processing_mode' => 'link_based_with_details_and_prompt_template', // ÏÉàÎ°úÏö¥ Ï≤òÎ¶¨ Î™®Îìú
        'link_conversion_required' => true, // ÎßÅÌÅ¨ Î≥ÄÌôò ÌïÑÏöî Ïó¨Î∂Ä
        'conversion_status' => [
            'coupang_converted' => 0,
            'coupang_total' => 0,
            'aliexpress_converted' => 0,
            'aliexpress_total' => 0
        ],
        'created_at' => date('Y-m-d H:i:s'),
        'status' => 'pending', // Initial status
        'priority' => 1, // Default priority
        'attempts' => 0,
        'last_error' => null,
        'has_user_details' => ($user_details_data !== null) // ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°¥Ïû¨ Ïó¨Î∂Ä
    ];
    
    // ÎßÅÌÅ¨ Ïπ¥Ïö¥Ìä∏ Í≥ÑÏÇ∞
    $coupang_total = 0;
    $aliexpress_total = 0;
    foreach ($cleaned_keywords as $keyword_item) {
        $coupang_total += count($keyword_item['coupang'] ?? []);
        $aliexpress_total += count($keyword_item['aliexpress'] ?? []);
    }
    $queue_data['conversion_status']['coupang_total'] = $coupang_total;
    $queue_data['conversion_status']['aliexpress_total'] = $aliexpress_total;
    
    debug_log("main_process: Queue data structure created. ID: " . $queue_data['queue_id']);
    debug_log("main_process: Prompt type: " . $input_data['prompt_type'] . " (" . get_prompt_type_name($input_data['prompt_type']) . ")");
    debug_log("main_process: Link counts - Coupang: {$coupang_total}, AliExpress: {$aliexpress_total}");
    debug_log("main_process: User details included: " . ($queue_data['has_user_details'] ? 'Yes' : 'No'));

    // Add to queue file
    if (!add_to_queue($queue_data)) {
        debug_log("main_process: Failed to add item to queue. check add_to_queue and save_queue functions.");
        $telegram_msg = "‚ùå ÌÅê ÌååÏùº Ï†ÄÏû• Ïã§Ìå®!\nÌååÏùº Í∂åÌïú ÎòêÎäî JSON Ïù∏ÏΩîÎî© Î¨∏Ï†úÏùº Ïàò ÏûàÏäµÎãàÎã§.";
        send_telegram_notification($telegram_msg, true);
        main_log("Failed to add item to queue.");
        redirect_to_editor(false, ['error' => 'ÌÅê ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.']);
    }
    debug_log("main_process: Item successfully added to queue.");

    // Get queue statistics for notification
    $stats = get_queue_stats();
    debug_log("main_process: Queue stats retrieved: " . json_encode($stats));

    $telegram_success_msg = "‚úÖ ÏÉà ÏûëÏóÖÏù¥ Î∞úÌñâ ÎåÄÍ∏∞Ïó¥Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!\n\n";
    $telegram_success_msg .= "üìã <b>ÏûëÏóÖ Ï†ïÎ≥¥</b>\n";
    $telegram_success_msg .= "‚Ä¢ Ï†úÎ™©: " . $input_data['title'] . "\n";
    $telegram_success_msg .= "‚Ä¢ Ïπ¥ÌÖåÍ≥†Î¶¨: " . $queue_data['category_name'] . "\n";
    $telegram_success_msg .= "‚Ä¢ ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ: " . $queue_data['prompt_type_name'] . "\n"; // üöÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
    $telegram_success_msg .= "‚Ä¢ ÌÇ§ÏõåÎìú Ïàò: " . count($cleaned_keywords) . "Í∞ú\n";
    $telegram_success_msg .= "‚Ä¢ Ï≤òÎ¶¨ Î™®Îìú: 4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÖúÌîåÎ¶ø ÏãúÏä§ÌÖú\n";
    $telegram_success_msg .= "‚Ä¢ Ïø†Ìå° ÎßÅÌÅ¨: " . $coupang_total . "Í∞ú\n";
    $telegram_success_msg .= "‚Ä¢ ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ ÎßÅÌÅ¨: " . $aliexpress_total . "Í∞ú\n";
    
    // ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏïåÎ¶º Ï∂îÍ∞Ä
    if ($user_details_data !== null) {
        $telegram_success_msg .= "‚Ä¢ ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥: " . format_user_details_summary($user_details_data) . "\n";
    } else {
        $telegram_success_msg .= "‚Ä¢ ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥: Ï†úÍ≥µÎêòÏßÄ ÏïäÏùå\n";
    }
    
    $telegram_success_msg .= "‚Ä¢ ÌÅê ID: " . $queue_data['queue_id'] . "\n";
    $telegram_success_msg .= "‚Ä¢ Îì±Î°ù ÏãúÍ∞Ñ: " . $queue_data['created_at'] . "\n\n";
    $telegram_success_msg .= "üìä <b>ÌòÑÏû¨ ÌÅê ÏÉÅÌÉú</b>\n";
    $telegram_success_msg .= "‚Ä¢ ÎåÄÍ∏∞ Ï§ë: " . $stats['pending'] . "Í∞ú\n";
    $telegram_success_msg .= "‚Ä¢ Ï≤òÎ¶¨ Ï§ë: " . $stats['processing'] . "Í∞ú\n";
    $telegram_success_msg .= "‚Ä¢ ÏôÑÎ£å: " . $stats['completed'] . "Í∞ú\n";
    if ($stats['failed'] > 0) {
        $telegram_success_msg .= "‚Ä¢ Ïã§Ìå®: " . $stats['failed'] . "Í∞ú\n";
    }
    $telegram_success_msg .= "\nüöÄ 4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ ÌÖúÌîåÎ¶ø ÏûêÎèôÌôî ÏãúÏä§ÌÖúÏù¥ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨Ìï† ÏòàÏ†ïÏûÖÎãàÎã§.";
    send_telegram_notification($telegram_success_msg);
    main_log("Item successfully added to queue with prompt type '{$input_data['prompt_type']}' and user details. Queue stats: " . json_encode($stats));

    // Redirect to editor with success message
    redirect_to_editor(true, ['success' => '1']);

    debug_log("main_process: Main processing finished. Exiting.");
}

// Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
try {
    main_process();
} catch (Throwable $e) { // Catch all errors and exceptions
    debug_log("Fatal Error Caught in main_process: " . $e->getMessage() . " on line " . $e->getLine() . " in " . $e->getFile());
    debug_log("Stack Trace: " . $e->getTraceAsString());

    $error_message_for_telegram = "‚ùå ÌÇ§ÏõåÎìú Ï≤òÎ¶¨Í∏∞ ÏπòÎ™ÖÏ†Å Ïò§Î•ò!\n\n";
    $error_message_for_telegram .= "Ïò§Î•ò ÎÇ¥Ïö©: " . $e->getMessage() . "\n";
    $error_message_for_telegram .= "ÌååÏùº: " . $e->getFile() . "\n";
    $error_message_for_telegram .= "ÎùºÏù∏: " . $e->getLine() . "\n";
    $error_message_for_telegram .= "Î∞úÏÉù ÏãúÍ∞Ñ: " . date('Y-m-d H:i:s') . "\n";
    
    send_telegram_notification($error_message_for_telegram, true);
    main_log("FATAL ERROR: " . $e->getMessage() . " at " . $e->getFile() . ":" . $e->getLine());

    // Redirect to editor with a generic error message
    redirect_to_editor(false, ['error' => 'ÏπòÎ™ÖÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.']);
}

exit; // Ensure script terminates after redirect
?>
