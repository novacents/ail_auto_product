<?php
/**
 * Affiliate Editor - ÌÇ§ÏõåÎìú Í∏∞Î∞ò ÏÉÅÌíà ÌÅêÎ†àÏù¥ÏÖò ÏãúÏä§ÌÖú
 * Î≤ÑÏ†Ñ: v2.7 (2025-08-06)
 * 
 * Ï£ºÏöî Í∏∞Îä•:
 * 1. ÏóëÏÖÄ ÌååÏùº ÏóÖÎ°úÎìú Î∞è ÌÇ§ÏõåÎìú Ï∂îÏ∂ú
 * 2. AliExpress ÏÉÅÌíà ÎßÅÌÅ¨ Î∂ÑÏÑù Î∞è Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
 * 3. ÌÇ§ÏõåÎìúÎ≥Ñ ÏÉÅÌíà Í∑∏Î£πÌïë Î∞è HTML ÏÉùÏÑ±
 * 4. WordPress Ìè¨Ïä§ÌåÖ ÏûêÎèôÌôî (Ï¶âÏãúÎ∞úÌñâ/ÌÅêÎì±Î°ù)
 * 5. ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Í¥ÄÎ¶¨
 */

// Ïò§Î•ò Î≥¥Í≥† ÏÑ§Ï†ï
error_reporting(E_ALL);
ini_set('display_errors', 0);
ini_set('log_errors', 1);
ini_set('error_log', '/var/www/novacents/tools/php_error_log.txt');

// WordPress ÏÑ§Ï†ï Î°úÎìú
require_once($_SERVER['DOCUMENT_ROOT'] . '/wp-config.php');

// ÏÑ∏ÏÖò ÏãúÏûë
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// ÏÇ¨Ïö©Ïûê Í∂åÌïú ÌôïÏù∏
if (!is_user_logged_in() || !current_user_can('edit_posts')) {
    wp_die('Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.');
}

// ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Ìï®Ïàò
function debug_log($message) {
    $timestamp = date('Y-m-d H:i:s');
    $log_message = "[$timestamp] [AFFILIATE_EDITOR] $message" . PHP_EOL;
    file_put_contents('/var/www/novacents/tools/debug_log.txt', $log_message, FILE_APPEND | LOCK_EX);
}

// Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù
$categories = [
    '354' => "Today's Pick",
    '355' => 'Í∏∞Î∞úÌïú Ïû°ÌôîÏ†ê',
    '356' => 'Ïä§ÎßàÌä∏ Î¶¨Îπô',
    '12' => 'Ïö∞Î¶¨ÏûáÌÖú'
];

// ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ Î™©Î°ù
$prompt_types = [
    'essential_items' => 'ÌïÑÏàòÌÖúÌòï üéØ',
    'friend_review' => 'ÏπúÍµ¨ Ï∂îÏ≤úÌòï üë´',
    'professional_analysis' => 'Ï†ÑÎ¨∏ Î∂ÑÏÑùÌòï üìä',
    'amazing_discovery' => 'ÎÜÄÎùºÏõÄ Î∞úÍ≤¨Ìòï ‚ú®'
];
?>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ ÏóêÎîîÌÑ∞ v2.7</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .version {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }
        
        .left-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .right-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8fbff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: #e8f4fd;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f8f5;
        }
        
        .keywords-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            background: #fafbfc;
        }
        
        .keyword-group {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .keyword-group:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }
        
        .keyword-group.selected {
            border-color: #27ae60;
            background: #f8fff8;
        }
        
        .keyword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .keyword-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .keyword-stats {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .products-list {
            display: grid;
            gap: 10px;
        }
        
        .product-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .product-item:hover {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        .product-item.selected {
            border-color: #27ae60;
            background: #e8f8f5;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .product-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .status-empty { background: #ecf0f1; color: #7f8c8d; }
        .status-analyzing { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .product-url {
            font-size: 0.8em;
            color: #7f8c8d;
            word-break: break-all;
            margin: 5px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.75em;
        }
        
        .progress-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .detail-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .detail-form .full-width {
            grid-column: span 2;
        }
        
        .advantages-inputs {
            display: grid;
            gap: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .modal-title {
            font-size: 1.3em;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .close {
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close:hover {
            color: #e74c3c;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2em;
            color: #2c3e50;
        }
        
        .batch-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .batch-progress {
            display: none;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }
        
        .navigation-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin: 15px 0;
        }
        
        .publish-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .title-suggestions {
            display: none;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 32px);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .title-suggestion {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }
        
        .title-suggestion:hover {
            background: #f8f9fa;
        }
        
        .title-suggestion:last-child {
            border-bottom: none;
        }
        
        .title-input-container {
            position: relative;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .right-panel {
                position: static;
            }
            
            .detail-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ ÏóêÎîîÌÑ∞</h1>
            <div class="version">v2.7 - ÌÇ§ÏõåÎìú Í∏∞Î∞ò ÏÉÅÌíà ÌÅêÎ†àÏù¥ÏÖò ÏãúÏä§ÌÖú</div>
        </div>

        <div class="main-layout">
            <div class="left-panel">
                <!-- ÌååÏùº ÏóÖÎ°úÎìú ÏÑπÏÖò -->
                <div class="section">
                    <h3 class="section-title">üìÅ ÏóëÏÖÄ ÌååÏùº ÏóÖÎ°úÎìú</h3>
                    
                    <div class="upload-area" onclick="document.getElementById('excelFile').click()">
                        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
                        <p style="font-size: 1.2em; margin-bottom: 10px; font-weight: 600;">ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Ïó¨Í∏∞Î°ú ÎìúÎûòÍ∑∏ÌïòÏÑ∏Ïöî</p>
                        <p style="color: #7f8c8d;">ÌÇ§ÏõåÎìúÏôÄ ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä Ìè¨Ìï®Îêú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</p>
                    </div>

                    <button class="btn" onclick="processExcel()" style="margin-top: 20px; width: 100%;">
                        üìã ÏóÖÎ°úÎìú & ÏûêÎèôÏûÖÎ†•
                    </button>
                </div>

                <!-- ÌÇ§ÏõåÎìú Î∞è ÏÉÅÌíà Í¥ÄÎ¶¨ ÏÑπÏÖò -->
                <div class="section">
                    <h3 class="section-title">üîç ÌÇ§ÏõåÎìú & ÏÉÅÌíà Í¥ÄÎ¶¨</h3>
                    
                    <div class="batch-controls">
                        <button class="btn" id="batchAnalyzeBtn" onclick="batchAnalyzeAll()">
                            üîç Ï†ÑÏ≤¥ Î∂ÑÏÑù
                        </button>
                        <button class="btn btn-success" id="batchSaveBtn" onclick="batchSaveAll()">
                            üíæ Ï†ÑÏ≤¥ Ï†ÄÏû•
                        </button>
                    </div>

                    <div class="batch-progress" id="batchProgress">
                        <div class="progress-text" id="batchProgressText">Ï≤òÎ¶¨ Ï§ë...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="batchProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="keywords-container" id="keywordsContainer">
                        <!-- ÌÇ§ÏõåÎìú Í∑∏Î£πÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <!-- Ï†úÎ™© ÏÉùÏÑ± ÏÑπÏÖò -->
                <div class="section">
                    <h3 class="section-title">üìù Ï†úÎ™© ÏÉùÏÑ±</h3>
                    
                    <div class="form-group">
                        <label for="titleKeyword">ÌÇ§ÏõåÎìú ÏûÖÎ†•</label>
                        <input type="text" id="titleKeyword" placeholder="Ï†úÎ™© ÏÉùÏÑ±Ïö© ÌÇ§ÏõåÎìú ÏûÖÎ†•">
                    </div>
                    
                    <button class="btn btn-secondary" onclick="generateTitles()" style="width: 100%; margin-bottom: 15px;">
                        ‚ú® Ï†úÎ™© ÏÉùÏÑ±
                    </button>
                    
                    <div class="title-input-container">
                        <div class="form-group">
                            <label for="title">Ï†úÎ™©</label>
                            <input type="text" id="title" placeholder="Ìè¨Ïä§ÌåÖ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                        </div>
                        <div class="title-suggestions" id="titleSuggestions"></div>
                    </div>
                </div>

                <!-- Í∏∞Î≥∏ ÏÑ§Ï†ï ÏÑπÏÖò -->
                <div class="section">
                    <h3 class="section-title">‚öôÔ∏è Í∏∞Î≥∏ ÏÑ§Ï†ï</h3>
                    
                    <div class="form-group">
                        <label for="category">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                        <select id="category">
                            <?php foreach ($categories as $id => $name): ?>
                                <option value="<?= $id ?>"><?= htmlspecialchars($name) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="prompt_type">ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ</label>
                        <select id="prompt_type">
                            <?php foreach ($prompt_types as $type => $name): ?>
                                <option value="<?= $type ?>"><?= htmlspecialchars($name) ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="thumbnail_url">Ïç∏ÎÑ§Ïùº URL</label>
                        <input type="url" id="thumbnail_url" placeholder="Ïç∏ÎÑ§Ïùº Ïù¥ÎØ∏ÏßÄ URL (ÏÑ†ÌÉùÏÇ¨Ìï≠)">
                    </div>
                </div>

                <!-- ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                <div class="section">
                    <h3 class="section-title">üìã ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h3>
                    
                    <div class="form-group">
                        <label for="productUrl">ÌòÑÏû¨ ÏÉÅÌíà URL</label>
                        <input type="url" id="productUrl" placeholder="ÏÑ†ÌÉùÎêú ÏÉÅÌíàÏùò URL">
                    </div>
                    
                    <div class="navigation-controls">
                        <button class="btn btn-secondary btn-small" onclick="previousProduct()">‚óÄ Ïù¥Ï†Ñ</button>
                        <button class="btn btn-secondary btn-small" onclick="nextProduct()">Îã§Ïùå ‚ñ∂</button>
                    </div>
                    
                    <button class="btn" onclick="saveCurrentProduct()" style="width: 100%; margin: 15px 0;">
                        üíæ ÌòÑÏû¨ ÏÉÅÌíà Ï†ÄÏû•
                    </button>
                    
                    <!-- ÏÉÅÌíà ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÏûÖÎ†• Ìèº -->
                    <div class="detail-form">
                        <!-- Ï†úÌíà ÏÇ¨Ïñë -->
                        <div class="form-group">
                            <label for="main_function">Ï£ºÏöî Í∏∞Îä•</label>
                            <input type="text" id="main_function" placeholder="Ïòà: Î¨¥ÏÑ†Ï∂©Ï†Ñ, ÌÑ∞ÏπòÏ°∞Ïûë">
                        </div>
                        <div class="form-group">
                            <label for="size_capacity">ÌÅ¨Í∏∞/Ïö©Îüâ</label>
                            <input type="text" id="size_capacity" placeholder="Ïòà: 500ml, 15x10cm">
                        </div>
                        <div class="form-group">
                            <label for="color">ÏÉâÏÉÅ</label>
                            <input type="text" id="color" placeholder="Ïòà: ÌôîÏù¥Ìä∏, Î∏îÎûô">
                        </div>
                        <div class="form-group">
                            <label for="material">Ïû¨Ïßà</label>
                            <input type="text" id="material" placeholder="Ïòà: Ïã§Î¶¨ÏΩò, Ïä§ÌÖåÏù∏Î¶¨Ïä§">
                        </div>
                        <div class="form-group">
                            <label for="power_battery">Ï†ÑÏõê/Î∞∞ÌÑ∞Î¶¨</label>
                            <input type="text" id="power_battery" placeholder="Ïòà: USB-C, Î¶¨Ìä¨Î∞∞ÌÑ∞Î¶¨">
                        </div>
                        
                        <!-- Ìö®Ïú®ÏÑ± Ï†ïÎ≥¥ -->
                        <div class="form-group">
                            <label for="problem_solving">Ìï¥Í≤∞ÌïòÎäî Î¨∏Ï†ú</label>
                            <input type="text" id="problem_solving" placeholder="Ïòà: Ï†ïÎ¶¨Ï†ïÎèà Ïñ¥Î†§ÏõÄ">
                        </div>
                        <div class="form-group">
                            <label for="time_saving">ÏãúÍ∞ÑÏ†àÏïΩ</label>
                            <input type="text" id="time_saving" placeholder="Ïòà: Ï≤≠ÏÜåÏãúÍ∞Ñ 50% Îã®Ï∂ï">
                        </div>
                        <div class="form-group">
                            <label for="space_efficiency">Í≥µÍ∞ÑÌö®Ïú®</label>
                            <input type="text" id="space_efficiency" placeholder="Ïòà: Î≤ΩÎ©¥ Î∂ÄÏ∞© Í∞ÄÎä•">
                        </div>
                        <div class="form-group">
                            <label for="cost_saving">ÎπÑÏö©Ï†àÏïΩ</label>
                            <input type="text" id="cost_saving" placeholder="Ïòà: ÏùºÌöåÏö©Ìíà ÎåÄÏ≤¥ Í∞ÄÎä•">
                        </div>
                        
                        <!-- ÏÇ¨Ïö©Î≤ï Ï†ïÎ≥¥ -->
                        <div class="form-group">
                            <label for="usage_location">ÏÇ¨Ïö© Ïû•ÏÜå</label>
                            <input type="text" id="usage_location" placeholder="Ïòà: Ï£ºÎ∞©, Ïπ®Ïã§, ÏÇ¨Î¨¥Ïã§">
                        </div>
                        <div class="form-group">
                            <label for="usage_frequency">ÏÇ¨Ïö© ÎπàÎèÑ</label>
                            <input type="text" id="usage_frequency" placeholder="Ïòà: Îß§Ïùº, Ï£º 3Ìöå">
                        </div>
                        <div class="form-group">
                            <label for="target_users">ÌÉÄÍ≤ü ÏÇ¨Ïö©Ïûê</label>
                            <input type="text" id="target_users" placeholder="Ïòà: ÏßÅÏû•Ïù∏, ÌïôÏÉù, Ï£ºÎ∂Ä">
                        </div>
                        <div class="form-group">
                            <label for="usage_method">ÏÇ¨Ïö© Î∞©Î≤ï</label>
                            <input type="text" id="usage_method" placeholder="Ïòà: ÏõêÌÑ∞Ïπò Ï°∞Ïûë, Ïï± Ïó∞Îèô">
                        </div>
                        
                        <!-- Ïû•Ï†ê Î∞è Ìö®Ïö© -->
                        <div class="form-group full-width">
                            <label>Ï£ºÏöî Ïû•Ï†ê</label>
                            <div class="advantages-inputs">
                                <input type="text" id="advantage1" placeholder="Ïû•Ï†ê 1">
                                <input type="text" id="advantage2" placeholder="Ïû•Ï†ê 2">
                                <input type="text" id="advantage3" placeholder="Ïû•Ï†ê 3">
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label for="precautions">Ï£ºÏùòÏÇ¨Ìï≠</label>
                            <textarea id="precautions" rows="3" placeholder="ÏÇ¨Ïö© Ïãú Ï£ºÏùòÏÇ¨Ìï≠Ïù¥ÎÇò Ï†úÌïúÏÇ¨Ìï≠"></textarea>
                        </div>
                    </div>
                </div>

                <!-- ÏßÑÌñâ ÏÉÅÌô© -->
                <div class="section">
                    <h3 class="section-title">üìä ÏßÑÌñâ ÏÉÅÌô©</h3>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">0/0 ÏôÑÏÑ±</div>
                    </div>
                </div>

                <!-- Î∞úÌñâ Ïª®Ìä∏Î°§ -->
                <div class="publish-controls">
                    <button class="btn btn-success" id="publishNowBtn" onclick="publishNow()">
                        üöÄ Ï¶âÏãú Î∞úÌñâ
                    </button>
                    <button class="btn" onclick="completeProduct()">
                        üìù ÌÅêÏóê Ï†ÄÏû•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...</div>
    </div>

    <!-- ÏÑ±Í≥µ Î™®Îã¨ -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="successTitle">ÏÑ±Í≥µ!</h3>
                <span class="close" onclick="closeModal('successModal')">&times;</span>
            </div>
            <div id="successMessage">ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.</div>
            <button class="btn" onclick="closeModal('successModal')" style="margin-top: 20px; width: 100%;">
                ÌôïÏù∏
            </button>
        </div>
    </div>

    <!-- Ïò§Î•ò Î™®Îã¨ -->
    <div class="modal" id="errorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="errorTitle">Ïò§Î•ò</h3>
                <span class="close" onclick="closeModal('errorModal')">&times;</span>
            </div>
            <div id="errorMessage">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>
            <div id="errorDetails" style="margin-top: 15px; font-size: 0.9em; color: #666;"></div>
            <button class="btn btn-danger" onclick="closeModal('errorModal')" style="margin-top: 20px; width: 100%;">
                ÌôïÏù∏
            </button>
        </div>
    </div>

    <!-- Ïà®Í≤®ÏßÑ Ìèº (Í∏∞Ï°¥ Ï†úÏ∂ú Î∞©ÏãùÏö©) -->
    <form id="affiliateForm" action="keyword_processor.php" method="post" style="display: none;">
        <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÎäî hidden inputÎì§ -->
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàòÎì§
        let keywords = [];
        let currentKeywordIndex = -1;
        let currentProductIndex = -1;
        let draggedElement = null;
        let draggedType = null;
        let draggedIndex = null;
        let draggedKeywordIndex = null;

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupDragAndDrop();
            updateUI();
            
            // Ï†úÎ™© ÏûÖÎ†• ÌïÑÎìúÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            const titleInput = document.getElementById('title');
            const suggestions = document.getElementById('titleSuggestions');
            
            titleInput.addEventListener('focus', function() {
                if (suggestions.children.length > 0) {
                    suggestions.style.display = 'block';
                }
            });
            
            titleInput.addEventListener('blur', function() {
                setTimeout(() => suggestions.style.display = 'none', 200);
            });
        });

        // ÌååÏùº ÏóÖÎ°úÎìú ÏÑ§Ï†ï
        function setupFileUpload() {
            const fileInput = document.getElementById('excelFile');
            const uploadArea = document.querySelector('.upload-area');
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadArea.style.background = '#e8f8f5';
                    uploadArea.innerHTML = `
                        <div style="font-size: 2em; margin-bottom: 10px;">‚úÖ</div>
                        <p style="font-size: 1.2em; font-weight: 600;">ÌååÏùº ÏÑ†ÌÉùÎê®: ${e.target.files[0].name}</p>
                        <p style="color: #7f8c8d;">ÏóÖÎ°úÎìú & ÏûêÎèôÏûÖÎ†• Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
                    `;
                }
            });
            
            // ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && (files[0].name.endsWith('.xlsx') || files[0].name.endsWith('.xls'))) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        // ÏóëÏÖÄ ÌååÏùº Ï≤òÎ¶¨
        function processExcel() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files[0]) {
                showDetailedError('ÌååÏùº Ïò§Î•ò', 'Î®ºÏ†Ä ÏóëÏÖÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (rows.length < 2) {
                        showDetailedError('Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò', 'ÏóëÏÖÄ ÌååÏùºÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä Ï∂©Î∂ÑÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                        return;
                    }
                    
                    parseExcelData(rows);
                    showSuccessModal('ÏóÖÎ°úÎìú ÏôÑÎ£å!', 'ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'üìä');
                } catch (error) {
                    showDetailedError('ÌååÏùº Ïò§Î•ò', 'ÏóëÏÖÄ ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', {
                        'error': error.message,
                        'filename': file.name
                    });
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞ ÌååÏã±
        function parseExcelData(rows) {
            keywords = [];
            const keywordMap = new Map();
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length < 2) continue;
                
                const keyword = String(row[0] || '').trim();
                const url = String(row[1] || '').trim();
                
                if (!keyword || !url) continue;
                
                if (!keywordMap.has(keyword)) {
                    keywordMap.set(keyword, {
                        name: keyword,
                        products: []
                    });
                }
                
                keywordMap.get(keyword).products.push({
                    name: `ÏÉÅÌíà ${keywordMap.get(keyword).products.length + 1}`,
                    url: url,
                    status: 'empty',
                    analysisData: null,
                    generatedHtml: null,
                    userData: {},
                    isSaved: false
                });
            }
            
            keywords = Array.from(keywordMap.values());
            updateUI();
        }

        // UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateUI() {
            updateKeywordsContainer();
            updateProgress();
        }

        function updateKeywordsContainer() {
            const container = document.getElementById('keywordsContainer');
            container.innerHTML = '';
            
            if (keywords.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <div style="font-size: 2em; margin-bottom: 15px;">üìã</div>
                        <p>ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ ÌÇ§ÏõåÎìúÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>
                    </div>
                `;
                return;
            }
            
            keywords.forEach((keyword, keywordIndex) => {
                const keywordDiv = document.createElement('div');
                keywordDiv.className = 'keyword-group';
                keywordDiv.draggable = true;
                keywordDiv.dataset.keywordIndex = keywordIndex;
                
                if (keywordIndex === currentKeywordIndex) {
                    keywordDiv.classList.add('selected');
                }
                
                const completedCount = keyword.products.filter(p => p.status === 'completed').length;
                const totalCount = keyword.products.length;
                
                keywordDiv.innerHTML = `
                    <div class="keyword-header">
                        <div class="keyword-title">${keyword.name}</div>
                        <div class="keyword-stats">${completedCount}/${totalCount}</div>
                    </div>
                    <div class="products-list">
                        ${keyword.products.map((product, productIndex) => `
                            <div class="product-item ${keywordIndex === currentKeywordIndex && productIndex === currentProductIndex ? 'selected' : ''}" 
                                 draggable="true" 
                                 data-keyword="${keywordIndex}" 
                                 data-product="${productIndex}"
                                 onclick="selectProduct(${keywordIndex}, ${productIndex})">
                                <div class="product-header">
                                    <div class="product-name">${product.name}</div>
                                    <div class="status-badge status-${product.status}">
                                        ${getStatusIcon(product.status, product.isSaved)}
                                    </div>
                                </div>
                                ${product.url ? `<div class="product-url">${product.url.length > 50 ? product.url.substring(0, 50) + '...' : product.url}</div>` : ''}
                                <div class="action-buttons">
                                    <button class="btn btn-small" onclick="event.stopPropagation(); analyzeProduct(${keywordIndex}, ${productIndex})">
                                        üîç Î∂ÑÏÑù
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); editProductUrl(${keywordIndex}, ${productIndex})">
                                        ‚úèÔ∏è ÏàòÏ†ï
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(keywordDiv);
            });
            
            setupDragAndDrop();
        }

        function selectProduct(keywordIndex, productIndex) {
            currentKeywordIndex = keywordIndex;
            currentProductIndex = productIndex;
            
            const product = keywords[keywordIndex].products[productIndex];
            document.getElementById('productUrl').value = product.url || '';
            
            // ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (product.userData) {
                const userData = product.userData;
                const specs = userData.specs || {};
                const efficiency = userData.efficiency || {};
                const usage = userData.usage || {};
                const benefits = userData.benefits || {};
                
                document.getElementById('main_function').value = specs.main_function || '';
                document.getElementById('size_capacity').value = specs.size_capacity || '';
                document.getElementById('color').value = specs.color || '';
                document.getElementById('material').value = specs.material || '';
                document.getElementById('power_battery').value = specs.power_battery || '';
                
                document.getElementById('problem_solving').value = efficiency.problem_solving || '';
                document.getElementById('time_saving').value = efficiency.time_saving || '';
                document.getElementById('space_efficiency').value = efficiency.space_efficiency || '';
                document.getElementById('cost_saving').value = efficiency.cost_saving || '';
                
                document.getElementById('usage_location').value = usage.usage_location || '';
                document.getElementById('usage_frequency').value = usage.usage_frequency || '';
                document.getElementById('target_users').value = usage.target_users || '';
                document.getElementById('usage_method').value = usage.usage_method || '';
                
                if (benefits.advantages) {
                    document.getElementById('advantage1').value = benefits.advantages[0] || '';
                    document.getElementById('advantage2').value = benefits.advantages[1] || '';
                    document.getElementById('advantage3').value = benefits.advantages[2] || '';
                }
                document.getElementById('precautions').value = benefits.precautions || '';
            }
            
            updateUI();
        }

        async function analyzeProduct(keywordIndex, productIndex) {
            const product = keywords[keywordIndex].products[productIndex];
            
            if (!product.url || product.url.trim() === '') {
                showDetailedError('URL Ïò§Î•ò', 'Î∂ÑÏÑùÌï† ÏÉÅÌíàÏùò URLÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            product.status = 'analyzing';
            updateUI();
            
            try {
                const response = await fetch('product_analyzer_v2.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'analyze_product',
                        url: product.url,
                        platform: 'aliexpress'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP Ïò§Î•ò: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    product.analysisData = result.data;
                    product.status = 'completed';
                    product.name = result.data.title || `ÏÉÅÌíà ${productIndex + 1}`;
                    
                    // HTML ÏÉùÏÑ±
                    const generatedHtml = generateOptimizedMobileHtml(result.data, false);
                    product.generatedHtml = generatedHtml;
                    
                    showSuccessModal('Î∂ÑÏÑù ÏôÑÎ£å!', `${product.name} ÏÉÅÌíà Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.`, 'üîç');
                } else {
                    product.status = 'error';
                    showDetailedError('Î∂ÑÏÑù Ïã§Ìå®', result.message || 'ÏÉÅÌíà Î∂ÑÏÑùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                product.status = 'error';
                showDetailedError('Î∂ÑÏÑù Ïò§Î•ò', 'ÏÉÅÌíà Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', {
                    'error': error.message,
                    'url': product.url
                });
            }
            
            updateUI();
        }

        function editProductUrl(keywordIndex, productIndex) {
            const product = keywords[keywordIndex].products[productIndex];
            const newUrl = prompt('ÏÉàÎ°úÏö¥ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', product.url || '');
            
            if (newUrl !== null && newUrl.trim() !== '') {
                product.url = newUrl.trim();
                product.status = 'empty';
                product.analysisData = null;
                product.generatedHtml = null;
                updateUI();
                
                showSuccessModal('URL ÏàòÏ†ï', 'ÏÉÅÌíà URLÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', '‚úèÔ∏è');
            }
        }

        // HTML ÏÉùÏÑ± Ìï®Ïàò
        function generateOptimizedMobileHtml(productData, includeStyles = true) {
            const styles = includeStyles ? `
            <style>
            .product-container { max-width: 100%; margin: 0 auto; padding: 15px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; }
            .product-image { width: 100%; max-width: 400px; height: auto; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
            .product-title { font-size: 1.4em; font-weight: 700; color: #333; margin-bottom: 15px; }
            .price-section { background: linear-gradient(135deg, #FF6B6B, #4ECDC4); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
            .current-price { font-size: 1.8em; font-weight: 800; margin-bottom: 5px; }
            .original-price { font-size: 1.1em; text-decoration: line-through; opacity: 0.8; }
            .discount-rate { font-size: 1.2em; font-weight: 600; margin-top: 8px; }
            .features-grid { display: grid; gap: 12px; margin-bottom: 20px; }
            .feature-item { background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #4ECDC4; }
            .feature-title { font-weight: 600; color: #333; margin-bottom: 5px; }
            .feature-content { color: #666; font-size: 0.95em; }
            .rating-section { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 12px; background: #fff8e1; border-radius: 8px; }
            .rating-stars { color: #ffc107; font-size: 1.2em; }
            .rating-text { font-weight: 600; color: #333; }
            .orders-count { color: #666; font-size: 0.9em; }
            .buy-button { background: linear-gradient(135deg, #FF6B6B, #4ECDC4); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; font-weight: 600; width: 100%; cursor: pointer; text-decoration: none; display: block; text-align: center; margin: 20px 0; }
            .shipping-info { background: #e8f5e8; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #2d5a2d; font-weight: 500; }
            @media (max-width: 768px) { .product-container { padding: 10px; } .features-grid { grid-template-columns: 1fr; } }
            </style>
            ` : '';
            
            const discountRate = productData.original_price && productData.current_price ? 
                Math.round((1 - parseFloat(productData.current_price.replace(/[^0-9.]/g, '')) / parseFloat(productData.original_price.replace(/[^0-9.]/g, ''))) * 100) : 0;
            
            return `${styles}
            <div class="product-container">
                ${productData.image_url ? `<img src="${productData.image_url}" alt="${productData.title}" class="product-image">` : ''}
                
                <h2 class="product-title">${productData.title || 'ÏÉÅÌíàÎ™Ö'}</h2>
                
                <div class="price-section">
                    <div class="current-price">${productData.current_price || 'Í∞ÄÍ≤© Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    ${productData.original_price && productData.original_price !== productData.current_price ? 
                        `<div class="original-price">Ï†ïÍ∞Ä: ${productData.original_price}</div>` : ''}
                    ${discountRate > 0 ? `<div class="discount-rate">üî• ${discountRate}% Ìï†Ïù∏!</div>` : ''}
                </div>
                
                ${productData.rating || productData.orders_count ? `
                <div class="rating-section">
                    ${productData.rating ? `
                        <div class="rating-stars">${'‚òÖ'.repeat(Math.floor(parseFloat(productData.rating)))}</div>
                        <div class="rating-text">${productData.rating}Ï†ê</div>
                    ` : ''}
                    ${productData.orders_count ? `<div class="orders-count">${productData.orders_count} Ï£ºÎ¨∏</div>` : ''}
                </div>
                ` : ''}
                
                ${productData.features && productData.features.length > 0 ? `
                <div class="features-grid">
                    ${productData.features.map(feature => `
                        <div class="feature-item">
                            <div class="feature-title">‚ú® Ï£ºÏöî ÌäπÏßï</div>
                            <div class="feature-content">${feature}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${productData.shipping_info ? `
                <div class="shipping-info">
                    üöö ${productData.shipping_info}
                </div>
                ` : ''}
                
                <a href="${productData.product_url}" class="buy-button" target="_blank">
                    üõí ÏßÄÍ∏à Íµ¨Îß§ÌïòÍ∏∞
                </a>
            </div>`;
        }

        // Ï†úÎ™© ÏÉùÏÑ± Ìï®Ïàò
        async function generateTitles() {
            const keyword = document.getElementById('titleKeyword').value.trim();
            if (!keyword) {
                showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'Ï†úÎ™© ÏÉùÏÑ±Ïö© ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const response = await fetch('title_generator.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        keyword: keyword,
                        count: 5
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.titles) {
                    const suggestions = document.getElementById('titleSuggestions');
                    suggestions.innerHTML = result.titles.map(title => 
                        `<div class="title-suggestion" onclick="selectTitle('${title.replace(/'/g, "\\'")}')">${title}</div>`
                    ).join('');
                    suggestions.style.display = 'block';
                    
                    // Ï≤´ Î≤àÏß∏ Ï†úÎ™©ÏùÑ ÏûêÎèôÏúºÎ°ú ÏûÖÎ†•
                    if (result.titles.length > 0) {
                        document.getElementById('title').value = result.titles[0];
                    }
                    
                    showSuccessModal('Ï†úÎ™© ÏÉùÏÑ± ÏôÑÎ£å!', `${result.titles.length}Í∞úÏùò Ï†úÎ™©Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.`, '‚ú®');
                } else {
                    showDetailedError('Ï†úÎ™© ÏÉùÏÑ± Ïã§Ìå®', result.message || 'Ï†úÎ™© ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                showDetailedError('Ï†úÎ™© ÏÉùÏÑ± Ïò§Î•ò', 'Ï†úÎ™© ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', {
                    'error': error.message,
                    'keyword': keyword
                });
            }
        }

        function selectTitle(title) {
            document.getElementById('title').value = title;
            document.getElementById('titleSuggestions').style.display = 'none';
        }

        // Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function showSuccessModal(title, message, icon = '‚úÖ') {
            document.getElementById('successTitle').textContent = icon + ' ' + title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').style.display = 'flex';
        }

        function showDetailedError(title, message, details = null) {
            document.getElementById('errorTitle').textContent = '‚ùå ' + title;
            document.getElementById('errorMessage').textContent = message;
            
            const detailsDiv = document.getElementById('errorDetails');
            if (details) {
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = '<strong>ÏÉÅÏÑ∏ Ï†ïÎ≥¥:</strong><br>' + 
                    Object.entries(details).map(([key, value]) => `${key}: ${value}`).join('<br>');
            } else {
                detailsDiv.style.display = 'none';
            }
            
            document.getElementById('errorModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ÏÉÅÌÉú ÏïÑÏù¥ÏΩò Í∞ÄÏ†∏Ïò§Í∏∞
        function getStatusIcon(status, isSaved = false) {
            switch (status) {
                case 'completed':
                    return isSaved ? '‚úÖ' : 'üîç';
                case 'analyzing':
                    return 'üîÑ';
                case 'error':
                    return '‚ö†Ô∏è';
                default:
                    return '‚ùå';
            }
        }

        // ÏßÑÌñâ ÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏
        function updateProgress() {
            const totalProducts = keywords.reduce((sum, keyword) => sum + keyword.products.length, 0);
            const completedProducts = keywords.reduce((sum, keyword) => 
                sum + keyword.products.filter(product => product.isSaved).length, 0);
            
            const percentage = totalProducts > 0 ? (completedProducts / totalProducts) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completedProducts}/${totalProducts} ÏôÑÏÑ±`;
        }

        // ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÏàòÏßë
        function collectUserInputDetails() {
            const details = {};
            const specs = {};
            const efficiency = {};
            const usage = {};
            const benefits = {};
            const advantages = [];
            
            // Ï†úÌíà ÏÇ¨Ïñë
            addIfNotEmpty(specs, 'main_function', 'main_function');
            addIfNotEmpty(specs, 'size_capacity', 'size_capacity');
            addIfNotEmpty(specs, 'color', 'color');
            addIfNotEmpty(specs, 'material', 'material');
            addIfNotEmpty(specs, 'power_battery', 'power_battery');
            if (Object.keys(specs).length > 0) details.specs = specs;
            
            // Ìö®Ïú®ÏÑ± Ï†ïÎ≥¥
            addIfNotEmpty(efficiency, 'problem_solving', 'problem_solving');
            addIfNotEmpty(efficiency, 'time_saving', 'time_saving');
            addIfNotEmpty(efficiency, 'space_efficiency', 'space_efficiency');
            addIfNotEmpty(efficiency, 'cost_saving', 'cost_saving');
            if (Object.keys(efficiency).length > 0) details.efficiency = efficiency;
            
            // ÏÇ¨Ïö©Î≤ï Ï†ïÎ≥¥
            addIfNotEmpty(usage, 'usage_location', 'usage_location');
            addIfNotEmpty(usage, 'usage_frequency', 'usage_frequency');
            addIfNotEmpty(usage, 'target_users', 'target_users');
            addIfNotEmpty(usage, 'usage_method', 'usage_method');
            if (Object.keys(usage).length > 0) details.usage = usage;
            
            // Ïû•Ï†ê ÏàòÏßë
            ['advantage1', 'advantage2', 'advantage3'].forEach(id => {
                const value = document.getElementById(id)?.value.trim();
                if (value) advantages.push(value);
            });
            if (advantages.length > 0) benefits.advantages = advantages;
            
            addIfNotEmpty(benefits, 'precautions', 'precautions');
            if (Object.keys(benefits).length > 0) details.benefits = benefits;
            
            return details;
        }

        function addIfNotEmpty(obj, key, elementId) {
            const value = document.getElementById(elementId)?.value.trim();
            if (value) obj[key] = value;
        }

        // ÌÇ§ÏõåÎìú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
        function collectKeywordsData() {
            const keywordsData = [];
            
            keywords.forEach((keyword, keywordIndex) => {
                const keywordData = {
                    name: keyword.name,
                    coupang: [],
                    aliexpress: [],
                    products_data: []
                };
                
                keyword.products.forEach((product, productIndex) => {
                    if (product.url && 
                        typeof product.url === 'string' && 
                        product.url.trim() !== '' && 
                        product.url.trim() !== 'undefined' && 
                        product.url.trim() !== 'null' && 
                        product.url.includes('aliexpress.com')) {
                        
                        const trimmedUrl = product.url.trim();
                        keywordData.aliexpress.push(trimmedUrl);
                        
                        const productData = {
                            url: trimmedUrl,
                            analysis_data: product.analysisData || null,
                            generated_html: product.generatedHtml || null,
                            user_data: product.userData || {}
                        };
                        
                        keywordData.products_data.push(productData);
                    }
                });
                
                if (keywordData.aliexpress.length > 0) {
                    keywordsData.push(keywordData);
                }
            });
            
            return keywordsData;
        }

        // Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù Î∞è Ï†úÏ∂ú
        function validateAndSubmitData(formData, isPrecheck = false) {
            // Ï†úÎ™© Í≤ÄÏ¶ù
            if (!formData.title || formData.title.length < 5) {
                showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'Ï†úÎ™©ÏùÄ 5Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return false;
            }
            
            // ÌÇ§ÏõåÎìú Í≤ÄÏ¶ù
            if (!formData.keywords || formData.keywords.length === 0) {
                showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'ÏµúÏÜå ÌïòÎÇòÏùò ÌÇ§ÏõåÎìúÏôÄ ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return false;
            }
            
            // AliExpress URL Í≤ÄÏ¶ù
            let hasValidUrls = false;
            let totalValidUrls = 0;
            let totalProductsData = 0;
            
            formData.keywords.forEach(keyword => {
                if (keyword.aliexpress && keyword.aliexpress.length > 0) {
                    const validUrls = keyword.aliexpress.filter(url => 
                        url && 
                        typeof url === 'string' && 
                        url.trim() !== '' && 
                        url.includes('aliexpress.com')
                    );
                    
                    if (validUrls.length > 0) {
                        hasValidUrls = true;
                        totalValidUrls += validUrls.length;
                        totalProductsData += keyword.products_data ? keyword.products_data.length : 0;
                    }
                }
            });
            
            if (!hasValidUrls || totalValidUrls === 0) {
                showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 
                    'Í∞Å ÌÇ§ÏõåÎìúÏóê ÏµúÏÜå ÌïòÎÇòÏùò Ïú†Ìö®Ìïú ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§.\n\n' +
                    'ÌòÑÏû¨ ÏÉÅÌÉú:\n' +
                    '- URLÏùÑ ÏûÖÎ†•ÌñàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî\n' +
                    '- Î∂ÑÏÑù Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌñàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî\n' +
                    '- ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ URLÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî'
                );
                return false;
            }
            
            if (isPrecheck) {
                return true;
            } else {
                // Ìèº Ï†úÏ∂ú
                const form = document.getElementById('affiliateForm');
                const existingInputs = form.querySelectorAll('input[type="hidden"]');
                existingInputs.forEach(input => input.remove());
                
                const hiddenInputs = [
                    { name: 'title', value: formData.title },
                    { name: 'category', value: formData.category },
                    { name: 'prompt_type', value: formData.prompt_type },
                    { name: 'keywords', value: JSON.stringify(formData.keywords) },
                    { name: 'user_details', value: JSON.stringify(formData.user_details) },
                    { name: 'thumbnail_url', value: document.getElementById('thumbnail_url').value.trim() }
                ];
                
                hiddenInputs.forEach(({ name, value }) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                });
                
                form.submit();
                return true;
            }
        }

        // Ï¶âÏãú Î∞úÌñâ
        async function publishNow() {
            const keywordsData = collectKeywordsData();
            const userDetails = collectUserInputDetails();
            const formData = {
                title: document.getElementById('title').value.trim(),
                category: document.getElementById('category').value,
                prompt_type: document.getElementById('prompt_type').value,
                keywords: keywordsData,
                user_details: userDetails,
                thumbnail_url: document.getElementById('thumbnail_url').value.trim()
            };
            
            if (!validateAndSubmitData(formData, true)) return;
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            const publishBtn = document.getElementById('publishNowBtn');
            
            loadingOverlay.style.display = 'flex';
            publishBtn.disabled = true;
            publishBtn.textContent = 'Î∞úÌñâ Ï§ë...';
            
            try {
                const response = await fetch('keyword_processor.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        title: formData.title,
                        category: formData.category,
                        prompt_type: formData.prompt_type,
                        keywords: JSON.stringify(formData.keywords),
                        user_details: JSON.stringify(formData.user_details),
                        thumbnail_url: formData.thumbnail_url,
                        publish_mode: 'immediate'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessModal('Î∞úÌñâ ÏôÑÎ£å!', 'Í∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞úÌñâÎêòÏóàÏäµÎãàÎã§!', 'üöÄ');
                    if (result.post_url) {
                        window.open(result.post_url, '_blank');
                    }
                } else {
                    showDetailedError('Î∞úÌñâ Ïã§Ìå®', result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                showDetailedError('Î∞úÌñâ Ïò§Î•ò', 'Ï¶âÏãú Î∞úÌñâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', {
                    'error': error.message,
                    'timestamp': new Date().toISOString()
                });
            } finally {
                loadingOverlay.style.display = 'none';
                publishBtn.disabled = false;
                publishBtn.textContent = 'üöÄ Ï¶âÏãú Î∞úÌñâ';
            }
        }

        // ÌòÑÏû¨ ÏÉÅÌíà Ï†ÄÏû•
        function saveCurrentProduct() {
            if (currentKeywordIndex === -1 || currentProductIndex === -1) {
                showDetailedError('ÏÑ†ÌÉù Ïò§Î•ò', 'Ï†ÄÏû•Ìï† ÏÉÅÌíàÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const product = keywords[currentKeywordIndex].products[currentProductIndex];
            const url = document.getElementById('productUrl').value.trim();
            if (url) product.url = url;
            
            const userDetails = collectUserInputDetails();
            product.userData = userDetails;
            product.isSaved = true;
            
            updateUI();
            showSuccessModal('Ï†ÄÏû• ÏôÑÎ£å!', 'ÌòÑÏû¨ ÏÉÅÌíà Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'üíæ');
        }

        // ÏôÑÎ£å Î∞è ÌÅêÏóê Ï†ÄÏû•
        function completeProduct() {
            const keywordsData = collectKeywordsData();
            const userDetails = collectUserInputDetails();
            const formData = {
                title: document.getElementById('title').value.trim(),
                category: document.getElementById('category').value,
                prompt_type: document.getElementById('prompt_type').value,
                keywords: keywordsData,
                user_details: userDetails,
                thumbnail_url: document.getElementById('thumbnail_url').value.trim()
            };
            
            if (validateAndSubmitData(formData)) {
                console.log('ÎåÄÍ∏∞Ïó¥ Ï†ÄÏû• ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.');
            }
        }

        // Ïù¥Ï†Ñ/Îã§Ïùå ÏÉÅÌíà ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        function previousProduct() {
            if (currentKeywordIndex === -1 || currentProductIndex === -1) return;
            
            const currentKeyword = keywords[currentKeywordIndex];
            if (currentProductIndex > 0) {
                selectProduct(currentKeywordIndex, currentProductIndex - 1);
            } else if (currentKeywordIndex > 0) {
                const previousKeyword = keywords[currentKeywordIndex - 1];
                selectProduct(currentKeywordIndex - 1, previousKeyword.products.length - 1);
            }
        }

        function nextProduct() {
            if (currentKeywordIndex === -1 || currentProductIndex === -1) return;
            
            const currentKeyword = keywords[currentKeywordIndex];
            if (currentProductIndex < currentKeyword.products.length - 1) {
                selectProduct(currentKeywordIndex, currentProductIndex + 1);
            } else if (currentKeywordIndex < keywords.length - 1) {
                selectProduct(currentKeywordIndex + 1, 0);
            }
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ÏÑ§Ï†ï
        function setupDragAndDrop() {
            const keywordGroups = document.querySelectorAll('.keyword-group');
            const productItems = document.querySelectorAll('.product-item');
            
            keywordGroups.forEach((group, index) => {
                group.addEventListener('dragstart', handleKeywordDragStart);
                group.addEventListener('dragend', handleDragEnd);
                group.addEventListener('dragover', handleDragOver);
                group.addEventListener('drop', handleKeywordDrop);
            });
            
            productItems.forEach((item, index) => {
                item.addEventListener('dragstart', handleProductDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleProductDrop);
            });
        }

        function handleKeywordDragStart(e) {
            if (!e.target.classList.contains('keyword-group')) return;
            e.stopPropagation();
            draggedElement = e.target;
            draggedType = 'keyword';
            draggedIndex = parseInt(e.target.dataset.keywordIndex);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleProductDragStart(e) {
            if (!e.target.classList.contains('product-item')) return;
            e.stopPropagation();
            draggedElement = e.target;
            draggedType = 'product';
            draggedKeywordIndex = parseInt(e.target.dataset.keyword);
            draggedIndex = parseInt(e.target.dataset.product);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedElement = null;
            draggedType = null;
            draggedIndex = null;
            draggedKeywordIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleKeywordDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedType !== 'keyword' || !e.target.closest('.keyword-group')) return;
            
            const targetGroup = e.target.closest('.keyword-group');
            if (!targetGroup || targetGroup === draggedElement) return;
            
            const targetIndex = parseInt(targetGroup.dataset.keywordIndex);
            
            if (draggedIndex !== targetIndex) {
                const draggedKeyword = keywords.splice(draggedIndex, 1)[0];
                keywords.splice(targetIndex, 0, draggedKeyword);
                
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌÇ§ÏõåÎìú Ïù∏Îç±Ïä§ Ï°∞Ï†ï
                if (currentKeywordIndex === draggedIndex) {
                    currentKeywordIndex = targetIndex;
                } else if (currentKeywordIndex === targetIndex) {
                    currentKeywordIndex = draggedIndex < targetIndex ? currentKeywordIndex + 1 : currentKeywordIndex - 1;
                } else if (currentKeywordIndex > Math.min(draggedIndex, targetIndex) && 
                          currentKeywordIndex <= Math.max(draggedIndex, targetIndex)) {
                    currentKeywordIndex += draggedIndex < targetIndex ? -1 : 1;
                }
                
                updateUI();
                showSuccessModal('ÌÇ§ÏõåÎìú ÏàúÏÑú Î≥ÄÍ≤Ω', 'ÌÇ§ÏõåÎìú ÏàúÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'üîÑ');
            }
        }

        function handleProductDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedType !== 'product' || !e.target.closest('.product-item')) return;
            
            const targetItem = e.target.closest('.product-item');
            if (!targetItem || targetItem === draggedElement) return;
            
            const targetKeywordIndex = parseInt(targetItem.dataset.keyword);
            const targetProductIndex = parseInt(targetItem.dataset.product);
            
            if (draggedKeywordIndex === targetKeywordIndex && draggedIndex === targetProductIndex) return;
            
            const draggedProduct = keywords[draggedKeywordIndex].products.splice(draggedIndex, 1)[0];
            keywords[targetKeywordIndex].products.splice(targetProductIndex, 0, draggedProduct);
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÉÅÌíà Ïù∏Îç±Ïä§ Ï°∞Ï†ï
            if (currentKeywordIndex === draggedKeywordIndex && currentProductIndex === draggedIndex) {
                currentKeywordIndex = targetKeywordIndex;
                currentProductIndex = targetProductIndex;
            } else if (currentKeywordIndex === targetKeywordIndex) {
                if (currentProductIndex >= targetProductIndex) {
                    currentProductIndex++;
                }
            }
            
            updateUI();
            showSuccessModal('ÏÉÅÌíà ÏàúÏÑú Î≥ÄÍ≤Ω', 'ÏÉÅÌíà ÏàúÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'üîÑ');
        }

        // ÏùºÍ¥Ñ Ï≤òÎ¶¨ Ìï®ÏàòÎì§
        async function batchAnalyzeAll() {
            const totalProducts = getAllProducts();
            if (totalProducts.length === 0) {
                showDetailedError('Î∂ÑÏÑù Ïò§Î•ò', 'Î∂ÑÏÑùÌï† ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const batchAnalyzeBtn = document.getElementById('batchAnalyzeBtn');
            const batchProgress = document.getElementById('batchProgress');
            const batchProgressText = document.getElementById('batchProgressText');
            const batchProgressBar = document.getElementById('batchProgressBar');
            
            batchAnalyzeBtn.disabled = true;
            batchAnalyzeBtn.textContent = 'Î∂ÑÏÑù Ï§ë...';
            batchProgress.style.display = 'block';
            
            let completed = 0;
            
            for (let i = 0; i < totalProducts.length; i++) {
                const { keywordIndex, productIndex, product } = totalProducts[i];
                
                try {
                    batchProgressText.textContent = `Î∂ÑÏÑù Ï§ë... (${completed + 1}/${totalProducts.length}) - ${product.name}`;
                    batchProgressBar.style.width = `${(completed / totalProducts.length) * 100}%`;
                    
                    if (product.url && product.url.trim() !== '' && product.status === 'empty') {
                        product.status = 'analyzing';
                        updateUI();
                        
                        const response = await fetch('product_analyzer_v2.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'analyze_product',
                                url: product.url,
                                platform: 'aliexpress'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP Ïò§Î•ò: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            product.analysisData = result.data;
                            product.status = 'completed';
                            product.name = result.data.title || `ÏÉÅÌíà ${productIndex + 1}`;
                            
                            const generatedHtml = generateOptimizedMobileHtml(result.data, false);
                            product.generatedHtml = generatedHtml;
                        } else {
                            product.status = 'error';
                            console.error(`ÏÉÅÌíà Î∂ÑÏÑù Ïã§Ìå®: ${result.message}`);
                        }
                    }
                } catch (error) {
                    product.status = 'error';
                    console.error(`ÏÉÅÌíà Î∂ÑÏÑù Ï§ë Ïò§Î•ò: ${error.message}`);
                }
                
                completed++;
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1Ï¥à ÏßÄÏó∞
            }
            
            batchProgressText.textContent = `Î∂ÑÏÑù ÏôÑÎ£å! (${completed}/${totalProducts.length})`;
            batchProgressBar.style.width = '100%';
            showSuccessModal('ÏùºÍ¥Ñ Î∂ÑÏÑù ÏôÑÎ£å!', `Ï¥ù ${completed}Í∞ú ÏÉÅÌíàÏùò Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.`, 'üîç');
            
            setTimeout(() => {
                batchProgress.style.display = 'none';
                batchAnalyzeBtn.disabled = false;
                batchAnalyzeBtn.textContent = 'üîç Ï†ÑÏ≤¥ Î∂ÑÏÑù';
            }, 3000);
        }

        async function batchSaveAll() {
            const totalProducts = getAllProducts();
            if (totalProducts.length === 0) {
                showDetailedError('Ï†ÄÏû• Ïò§Î•ò', 'Ï†ÄÏû•Ìï† ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const batchSaveBtn = document.getElementById('batchSaveBtn');
            const batchProgress = document.getElementById('batchProgress');
            const batchProgressText = document.getElementById('batchProgressText');
            const batchProgressBar = document.getElementById('batchProgressBar');
            
            batchSaveBtn.disabled = true;
            batchSaveBtn.textContent = 'Ï†ÄÏû• Ï§ë...';
            batchProgress.style.display = 'block';
            
            let completed = 0;
            
            // Í∞úÎ≥Ñ ÏÉÅÌíà Ï†ÄÏû• Ï≤òÎ¶¨
            for (let i = 0; i < totalProducts.length; i++) {
                const { keywordIndex, productIndex, product } = totalProducts[i];
                
                try {
                    batchProgressText.textContent = `Ï†ÄÏû• Ï§ë... (${completed + 1}/${totalProducts.length}) - ${product.name}`;
                    batchProgressBar.style.width = `${(completed / totalProducts.length) * 100}%`;
                    
                    if (product.url && product.url.trim() !== '' && product.status === 'completed' && !product.isSaved) {
                        product.isSaved = true;
                    }
                } catch (error) {
                    console.error(`ÏÉÅÌíà Ï†ÄÏû• Ï§ë Ïò§Î•ò: ${error.message}`);
                }
                
                completed++;
                updateUI();
                await new Promise(resolve => setTimeout(resolve, 200)); // 0.2Ï¥à ÏßÄÏó∞
            }
            
            // ÌÅê Ï†ÄÏû• Ï≤òÎ¶¨
            batchProgressText.textContent = 'ÌÅê Ï†ÄÏû• Ï§ë...';
            batchProgressBar.style.width = '90%';
            
            try {
                const keywordsData = collectKeywordsData();
                const userDetails = collectUserInputDetails();
                const formData = {
                    title: document.getElementById('title').value.trim(),
                    category: document.getElementById('category').value,
                    prompt_type: document.getElementById('prompt_type').value,
                    keywords: keywordsData,
                    user_details: userDetails,
                    thumbnail_url: document.getElementById('thumbnail_url').value.trim()
                };
                
                if (!validateAndSubmitData(formData, true)) {
                    showDetailedError('Ï†ÄÏû• Ïò§Î•ò', 'ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    return;
                }
                
                const response = await fetch('keyword_processor.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        title: formData.title,
                        category: formData.category,
                        prompt_type: formData.prompt_type,
                        keywords: JSON.stringify(formData.keywords),
                        user_details: JSON.stringify(formData.user_details),
                        thumbnail_url: formData.thumbnail_url,
                        publish_mode: 'queue'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    batchProgressText.textContent = `ÏôÑÎ£å! ÌÅêÏóê Ï†ÄÏû•Îê® (${completed}/${totalProducts.length})`;
                    batchProgressBar.style.width = '100%';
                    showSuccessModal('ÏùºÍ¥Ñ Ï†ÄÏû• ÏôÑÎ£å!', `Ï¥ù ${completed}Í∞ú ÏÉÅÌíàÏù¥ Ï†ÄÏû•ÎêòÍ≥† ÌÅêÏóê Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.`, 'üíæ');
                } else {
                    throw new Error(result.message || 'ÌÅê Ï†ÄÏû• Ïã§Ìå®');
                }
            } catch (error) {
                console.error('ÌÅê Ï†ÄÏû• Ïò§Î•ò:', error);
                batchProgressText.textContent = 'Ï†ÄÏû• ÏôÑÎ£å, ÌÅê Îì±Î°ù Ïã§Ìå®';
                showSuccessModal('Î∂ÄÎ∂Ñ ÏôÑÎ£å', `ÏÉÅÌíà Ï†ÄÏû•ÏùÄ ÏôÑÎ£åÎêòÏóàÏúºÎÇò ÌÅê Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÏò§Î•ò: ${error.message}`, '‚ö†Ô∏è');
            } finally {
                setTimeout(() => {
                    batchProgress.style.display = 'none';
                    batchSaveBtn.disabled = false;
                    batchSaveBtn.textContent = 'üíæ Ï†ÑÏ≤¥ Ï†ÄÏû•';
                }, 3000);
            }
        }

        function getAllProducts() {
            const products = [];
            keywords.forEach((keyword, keywordIndex) => {
                keyword.products.forEach((product, productIndex) => {
                    products.push({ keywordIndex, productIndex, product });
                });
            });
            return products;
        }

        // Ï†úÎ™© ÌÇ§ÏõåÎìú ÏûÖÎ†•ÏóêÏÑú ÏóîÌÑ∞ ÌÇ§ Ï≤òÎ¶¨
        document.getElementById('titleKeyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                generateTitles();
            }
        });
    </script>
</body>
</html>