<?php
/**
 * Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ ÏÉÅÌíà Îì±Î°ù ÏûêÎèôÌôî ÏûÖÎ†• ÌéòÏù¥ÏßÄ (AliExpress Í≥µÏãù Ïä§ÌÉÄÏùº - Ï¢åÏö∞ Î∂ÑÌï† + üì± Î∞òÏùëÌòï)
 * ÎÖ∏Î∞îÏÑºÌä∏(novacents.com) Ï†ÑÏö© - ÏïïÏ∂ï ÏµúÏ†ÅÌôî Î≤ÑÏ†Ñ + ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏàòÏßë Í∏∞Îä• + ÌîÑÎ°¨ÌîÑÌä∏ ÏÑ†ÌÉù Í∏∞Îä•
 * ÏàòÏ†ï: ÏÉà ÏÉÅÌíà ÏÑ†ÌÉù Ïãú ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî Í∏∞Îä• Ï∂îÍ∞Ä + ÏßÑÌñâÎ•† Í≥ÑÏÇ∞ ÏàòÏ†ï (Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠ ÏãúÏóêÎßå ÏôÑÎ£å) + ÏÉÅÎã® Ïù¥Îèô Î≤ÑÌäº Ï∂îÍ∞Ä + ÌÇ§ÏõåÎìú/ÏÉÅÌíà ÏÇ≠Ï†ú Í∏∞Îä• Ï∂îÍ∞Ä
 */
require_once($_SERVER['DOCUMENT_ROOT'] . '/wp-config.php');
if (!current_user_can('manage_options')) { wp_die('Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.'); }
$env_file = '/home/novacents/.env'; $env_vars = [];
if (file_exists($env_file)) {
    $lines = file($env_file, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        if (strpos($line, '=') !== false && strpos($line, '#') !== 0) {
            list($key, $value) = explode('=', $line, 2); $env_vars[trim($key)] = trim($value);
        }
    }
}
if (isset($_POST['action']) && $_POST['action'] === 'generate_titles') {
    header('Content-Type: application/json');
    $keywords_input = sanitize_text_field($_POST['keywords']);
    if (empty($keywords_input)) { echo json_encode(['success' => false, 'message' => 'ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.']); exit; }
    $keywords = array_map('trim', explode(',', $keywords_input)); $keywords = array_filter($keywords);
    if (empty($keywords)) { echo json_encode(['success' => false, 'message' => 'Ïú†Ìö®Ìïú ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.']); exit; }
    $combined_keywords = implode(',', $keywords);
    $script_locations = [__DIR__ . '/title_generator.py', '/home/novacents/title_generator.py'];
    $output = null; $found_script = false;
    foreach ($script_locations as $script_path) {
        if (file_exists($script_path)) {
            $script_dir = dirname($script_path);
            $command = "LANG=ko_KR.UTF-8 /usr/bin/env /usr/bin/python3 " . escapeshellarg($script_path) . " " . escapeshellarg($combined_keywords) . " 2>&1";
            $descriptorspec = [0 => ["pipe", "r"], 1 => ["pipe", "w"], 2 => ["pipe", "w"]];
            $process = proc_open($command, $descriptorspec, $pipes, $script_dir, null);
            if (is_resource($process)) {
                fclose($pipes[0]); $output = stream_get_contents($pipes[1]); $error_output = stream_get_contents($pipes[2]);
                fclose($pipes[1]); fclose($pipes[2]); $return_code = proc_close($process);
                if ($return_code === 0 && !empty($output)) { $found_script = true; break; }
            }
        }
    }
    if (!$found_script) { echo json_encode(['success' => false, 'message' => 'Python Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò Ïã§ÌñâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.']); exit; }
    $result = json_decode(trim($output), true);
    if ($result === null) { echo json_encode(['success' => false, 'message' => 'Python Ïä§ÌÅ¨Î¶ΩÌä∏ ÏùëÎãµ ÌååÏã± Ïã§Ìå®.', 'raw_output' => $output]); exit; }
    echo json_encode($result); exit;
}

$success_message = ''; $error_message = '';
if (isset($_GET['success']) && $_GET['success'] == '1') { $success_message = 'Í∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞úÌñâ ÎåÄÍ∏∞Ïó¥Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!'; }
if (isset($_GET['error'])) { $error_message = 'Ïò§Î•ò: ' . urldecode($_GET['error']); }
?>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ ÏÉÅÌíà Îì±Î°ù - ÎÖ∏Î∞îÏÑºÌä∏</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:0;padding:20px;background-color:#f5f5f5;min-width:1200px;color:#1c1c1c}
.main-container{width:1800px;margin:0 auto;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
.header-section{padding:30px;border-bottom:1px solid #e0e0e0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
.header-section h1{margin:0 0 10px 0;font-size:28px}
.header-section .subtitle{margin:0 0 20px 0;opacity:0.9}
.header-form{display:grid;grid-template-columns:1fr 250px 250px;gap:15px;margin-top:20px}
.title-section{position:relative}
.title-input-row{display:flex;gap:10px;align-items:flex-end}
.title-input-row input{flex:1;padding:12px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;background:rgba(255,255,255,0.1);color:white;font-size:16px}
.title-input-row input::placeholder{color:rgba(255,255,255,0.7)}
.category-section select,.prompt-section select{width:100%;padding:12px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;background:rgba(255,255,255,0.1);color:white;font-size:16px}
.category-section select option,.prompt-section select option{background:#333;color:white}

/* ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ï∂îÍ∞Ä */
.nav-links{display:flex;gap:10px;margin-top:15px}
.nav-link{background:rgba(255,255,255,0.2);color:white;padding:8px 16px;border-radius:4px;text-decoration:none;font-size:14px;transition:all 0.3s}
.nav-link:hover{background:rgba(255,255,255,0.3);color:white}

.main-content{display:flex;min-height:600px}
.products-sidebar{width:600px;border-right:1px solid #e0e0e0;background:#fafafa;display:flex;flex-direction:column}
.sidebar-header{padding:20px;border-bottom:1px solid #e0e0e0;background:white}
.progress-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.progress-text{font-weight:bold;color:#333}
.progress-bar{flex:1;height:8px;background:#e0e0e0;border-radius:4px;margin:0 15px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#4CAF50,#45a049);width:0%;transition:width 0.3s ease}
.products-list{flex:1;overflow-y:auto;padding:0}
.keyword-group{border-bottom:1px solid #e0e0e0}
.keyword-header{padding:15px 20px;background:white;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.keyword-header:hover{background:#f8f9fa}
.keyword-info{display:flex;align-items:center;gap:10px}
.keyword-name{font-weight:600;color:#333}
.product-count{background:#007bff;color:white;padding:2px 8px;border-radius:12px;font-size:12px}
.keyword-actions{display:flex;gap:8px}
.product-item{padding:12px 40px;border-bottom:1px solid #f5f5f5;display:flex;align-items:center;gap:10px;cursor:pointer;transition:background 0.2s}
.product-item:hover{background:#f0f8ff}
.product-item.active{background:#e3f2fd;border-left:4px solid #2196F3}
.product-status{font-size:18px;width:20px}
.product-name{flex:1;font-size:14px;color:#555}
.product-actions{display:flex;gap:5px;margin-left:auto}
.sidebar-actions{padding:15px 20px;border-bottom:1px solid #e0e0e0;background:white}
.keyword-input-section{margin-top:10px;padding:15px;background:#f8f9fa;border-radius:6px;border:1px solid #e9ecef;display:none}
.keyword-input-section.show{display:block}
.keyword-input-row-inline{display:flex;gap:10px;align-items:center}
.keyword-input-row-inline input{flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px}
.keyword-input-row-inline button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:600}
.detail-panel{flex:1;width:1100px;padding:30px;overflow-y:auto}
.detail-header{margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid #f0f0f0}

/* üöÄ ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº Ïä§ÌÉÄÏùº */
.top-navigation{margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:8px;border:1px solid #e9ecef}
.nav-buttons{display:flex;align-items:center;gap:10px}
.nav-buttons-left{display:flex;gap:10px}
.nav-divider{width:2px;height:40px;background:#ddd;margin:0 20px}
.nav-buttons-right{display:flex;gap:15px}
.btn-orange{background:#ff9900;color:white;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s;text-decoration:none;display:inline-block}
.btn-orange:hover{background:#e68a00;transform:translateY(-1px)}
.btn-orange:disabled{background:#ccc;cursor:not-allowed;transform:none}

/* Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ */
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:none;align-items:center;justify-content:center}
.loading-content{background:white;border-radius:10px;padding:40px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
.loading-spinner{display:inline-block;width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #ff9900;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
.loading-text{font-size:18px;color:#333;font-weight:600}

/* üîù ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô Î≤ÑÌäº Ïä§ÌÉÄÏùº */
.scroll-to-top{position:fixed;bottom:30px;right:30px;width:50px;height:50px;background:#667eea;color:white;border:none;border-radius:50%;cursor:pointer;font-size:20px;display:none;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.2);transition:all 0.3s;z-index:1000}
.scroll-to-top:hover{background:#764ba2;transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.3)}
.scroll-to-top.show{display:flex}

.product-url-section{margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:8px;border:1px solid #e9ecef}
.url-input-group{display:flex;gap:10px;margin-bottom:15px}
.url-input-group input{flex:1;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px}
.analysis-result{margin-top:15px;padding:20px;background:white;border-radius:8px;border:1px solid #ddd;display:none}
.analysis-result.show{display:block}
.product-card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 2px 12px rgba(0,0,0,0.08);border:1px solid #f0f0f0;margin-bottom:20px}
.product-content-split{display:grid;grid-template-columns:400px 1fr;gap:30px;align-items:start;margin-bottom:25px}
.product-image-large{width:100%}
.product-image-large img{width:100%;max-width:400px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.15)}
.product-info-all{display:flex;flex-direction:column;gap:20px}
.aliexpress-logo-right{margin-bottom:15px}
.aliexpress-logo-right img{width:250px;height:60px;object-fit:contain}
.product-title-right{color:#1c1c1c;font-size:21px;font-weight:600;line-height:1.4;margin:0 0 20px 0;word-break:keep-all;overflow-wrap:break-word}
.product-price-right{background:linear-gradient(135deg,#e62e04 0%,#ff9900 100%);color:white;padding:14px 30px;border-radius:10px;font-size:40px;font-weight:700;text-align:center;margin-bottom:20px;box-shadow:0 4px 15px rgba(230,46,4,0.3)}
.product-rating-right{color:#1c1c1c;font-size:20px;display:flex;align-items:center;gap:10px;margin-bottom:15px}
.rating-stars{color:#ff9900}
.product-sales-right{color:#1c1c1c;font-size:18px;margin-bottom:15px}
.product-extra-info-right{background:#f8f9fa;border-radius:8px;padding:20px;margin-top:15px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee;font-size:16px}
.info-row:last-child{border-bottom:none}
.info-label{color:#666;font-weight:500}
.info-value{color:#1c1c1c;font-weight:600}
.purchase-button-full{text-align:center;margin-top:30px;width:100%}
.purchase-button-full img{max-width:100%;height:auto;cursor:pointer;transition:transform 0.2s ease}
.purchase-button-full img:hover{transform:scale(1.02)}
.html-source-section{margin-top:30px;padding:20px;background:#f1f8ff;border-radius:8px;border:1px solid #b3d9ff}
.html-source-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.html-source-header h4{margin:0;color:#0066cc;font-size:18px}
.copy-btn{padding:8px 16px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s}
.copy-btn:hover{background:#0056b3}
.copy-btn.copied{background:#28a745}
.html-preview{background:white;border:1px solid #ddd;border-radius:8px;padding:20px;margin-bottom:15px}
.html-code{background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:15px;font-family:'Courier New',monospace;font-size:12px;line-height:1.4;overflow-x:auto;white-space:pre;color:#333;max-height:300px;overflow-y:auto}
.preview-product-card{display:flex;justify-content:center;margin:25px 0}
.preview-card-content{border:2px solid #eee;padding:30px;border-radius:15px;background:#f9f9f9;box-shadow:0 4px 8px rgba(0,0,0,0.1);max-width:1000px;width:100%}
.preview-content-split{display:grid;grid-template-columns:400px 1fr;gap:30px;align-items:start;margin-bottom:25px}
.preview-image-large{width:100%;max-width:400px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.15)}
.preview-info-all{display:flex;flex-direction:column;gap:20px}
.preview-aliexpress-logo{margin-bottom:15px}
.preview-aliexpress-logo img{width:250px;height:60px;object-fit:contain}
.preview-card-title{color:#1c1c1c;margin:0 0 20px 0;font-size:21px;font-weight:600;line-height:1.4;word-break:keep-all;overflow-wrap:break-word}
.preview-price-main{background:linear-gradient(135deg,#e62e04 0%,#ff9900 100%);color:white;padding:14px 30px;border-radius:10px;font-size:40px;font-weight:700;text-align:center;margin:0 0 20px 0;box-shadow:0 4px 15px rgba(230,46,4,0.3)}
.preview-rating{color:#1c1c1c;font-size:20px;display:flex;align-items:center;gap:10px;margin:0 0 15px 0}
.preview-rating .rating-stars{color:#ff9900}
.preview-sales{color:#1c1c1c;font-size:18px;margin:0 0 15px 0}
.preview-button-container{text-align:center;margin-top:30px}
.preview-button-container img{max-width:100%;height:auto;cursor:pointer}
.user-input-section{margin-top:30px}
.input-group{margin-bottom:30px;padding:20px;background:white;border:1px solid #e0e0e0;border-radius:8px}
.input-group h3{margin:0 0 20px 0;padding-bottom:10px;border-bottom:2px solid #f0f0f0;color:#333;font-size:18px}
.form-row{display:grid;gap:15px;margin-bottom:15px}
.form-row.two-col{grid-template-columns:1fr 1fr}
.form-row.three-col{grid-template-columns:1fr 1fr 1fr}
.form-field label{display:block;margin-bottom:5px;font-weight:600;color:#333;font-size:14px}
.form-field input,.form-field textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box}
.form-field textarea{min-height:60px;resize:vertical}
.advantages-list{list-style:none;padding:0;margin:0}
.advantages-list li{margin-bottom:10px}
.advantages-list input{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
.btn{padding:12px 20px;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s;text-decoration:none;display:inline-block;margin:0 5px}
.btn-primary{background-color:#007bff;color:white}
.btn-primary:hover{background-color:#0056b3}
.btn-secondary{background-color:#6c757d;color:white}
.btn-secondary:hover{background-color:#545b62}
.btn-success{background-color:#28a745;color:white}
.btn-success:hover{background-color:#1e7e34}
.btn-danger{background-color:#dc3545;color:white}
.btn-danger:hover{background-color:#c82333}
.btn-small{padding:6px 12px;font-size:12px}
.btn-large{padding:15px 30px;font-size:16px}
.keyword-generator{margin-top:15px;padding:15px;background-color:rgba(255,255,255,0.1);border-radius:6px;display:none}
.keyword-input-row{display:flex;gap:10px;margin-bottom:15px}
.keyword-input-row input{flex:1;padding:10px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.1);color:white}
.generated-titles{margin-top:15px}
.title-options{display:grid;gap:8px}
.title-option{padding:12px 15px;background-color:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.3);border-radius:6px;cursor:pointer;transition:all 0.2s;text-align:left;color:white}
.title-option:hover{background-color:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.6)}
.loading{display:none;text-align:center;color:rgba(255,255,255,0.8);margin-top:10px}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top:3px solid white;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.alert{padding:15px;border-radius:6px;margin-bottom:20px}
.alert-success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}
.alert-error{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.empty-state{text-align:center;padding:40px 20px;color:#666}
.empty-state h3{margin:0 0 10px 0;color:#999}
</style>
</head>
<body>
<!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">Í∏ÄÏùÑ Î∞úÌñâÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>
        <div style="margin-top: 10px; color: #666; font-size: 14px;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</div>
    </div>
</div>

<!-- üîù ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô Î≤ÑÌäº -->
<button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()">‚¨ÜÔ∏è</button>

<div class="main-container">
<div class="header-section">
<h1>üõçÔ∏è Ïñ¥ÌïÑÎ¶¨ÏóêÏù¥Ìä∏ ÏÉÅÌíà Îì±Î°ù</h1>
<p class="subtitle">ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ Ï†ÑÏö© ÏÉÅÌíà Í∏Ä ÏÉùÏÑ±Í∏∞ + ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌôúÏö© + ÌîÑÎ°¨ÌîÑÌä∏ ÏÑ†ÌÉù</p>

<!-- ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎßÅÌÅ¨ Ï∂îÍ∞Ä -->
<div class="nav-links">
    <a href="queue_manager.php" class="nav-link">üìã Ï†ÄÏû•Îêú Ï†ïÎ≥¥ Í¥ÄÎ¶¨</a>
</div>

<?php if (!empty($success_message)): ?>
<div class="alert alert-success"><?php echo esc_html($success_message); ?></div>
<?php endif; ?>
<?php if (!empty($error_message)): ?>
<div class="alert alert-error"><?php echo esc_html($error_message); ?></div>
<?php endif; ?>
<form method="POST" action="keyword_processor.php" id="affiliateForm">
<div class="header-form">
<div class="title-section">
<label for="title" style="color: rgba(255,255,255,0.9); margin-bottom: 8px; display: block;">Í∏Ä Ï†úÎ™©</label>
<div class="title-input-row">
<input type="text" id="title" name="title" placeholder="Í∏Ä Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏïÑÎûò 'Ï†úÎ™© ÏÉùÏÑ±' Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî" required>
<button type="button" class="btn btn-secondary" onclick="toggleTitleGenerator()">Ï†úÎ™© ÏÉùÏÑ±</button>
</div>
<div class="keyword-generator" id="titleGenerator">
<label for="titleKeyword" style="color: rgba(255,255,255,0.9);">Ï†úÎ™© ÏÉùÏÑ± ÌÇ§ÏõåÎìú (ÏΩ§ÎßàÎ°ú Íµ¨Î∂Ñ)</label>
<div class="keyword-input-row">
<input type="text" id="titleKeyword" placeholder="Ïòà: Î¨ºÎÜÄÏù¥Ïö©Ìíà, ÎπÑÏπòÏõ®Ïñ¥, Ïó¨Î¶ÑÏö©Ìíà">
<button type="button" class="btn btn-primary" onclick="generateTitles()">ÏÉùÏÑ±</button>
</div>
<div class="loading" id="titleLoading">
<div class="spinner"></div>
Ï†úÎ™©ÏùÑ ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...
</div>
<div class="generated-titles" id="generatedTitles" style="display:none;">
<label style="color: rgba(255,255,255,0.9);">Ï∂îÏ≤ú Ï†úÎ™© (ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù)</label>
<div class="title-options" id="titleOptions"></div>
</div>
</div>
</div>
<div class="category-section">
<label for="category" style="color: rgba(255,255,255,0.9); margin-bottom: 8px; display: block;">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
<select id="category" name="category" required>
<option value="356" selected>Ïä§ÎßàÌä∏ Î¶¨Îπô</option>
<option value="355">Í∏∞Î∞úÌïú Ïû°ÌôîÏ†ê</option>
<option value="354">Today's Pick</option>
<option value="12">Ïö∞Î¶¨ÏûáÌÖú</option>
</select>
</div>
<div class="prompt-section">
<label for="prompt_type" style="color: rgba(255,255,255,0.9); margin-bottom: 8px; display: block;">ÌîÑÎ°¨ÌîÑÌä∏ Ïä§ÌÉÄÏùº</label>
<select id="prompt_type" name="prompt_type" required>
<option value="essential_items" selected>Ï£ºÏ†úÎ≥Ñ ÌïÑÏàòÌÖúÌòï</option>
<option value="friend_review">ÏπúÍµ¨ Ï∂îÏ≤úÌòï</option>
<option value="professional_analysis">Ï†ÑÎ¨∏ Î∂ÑÏÑùÌòï</option>
<option value="amazing_discovery">ÎÜÄÎùºÏõÄ Î∞úÍ≤¨Ìòï</option>
</select>
</div>
</div>
</form>
</div>
<div class="main-content">
<div class="products-sidebar">
<div class="sidebar-header">
<div class="progress-info">
<span class="progress-text">ÏßÑÌñâÎ•†</span>
<div class="progress-bar">
<div class="progress-fill" id="progressFill"></div>
</div>
<span class="progress-text" id="progressText">0/0 ÏôÑÏÑ±</span>
</div>
</div>
<div class="sidebar-actions">
<button type="button" class="btn btn-primary" onclick="toggleKeywordInput()" style="width: 100%; margin-bottom: 10px;">üìÅ ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä</button>
<div class="keyword-input-section" id="keywordInputSection">
<div class="keyword-input-row-inline">
<input type="text" id="newKeywordInput" placeholder="ÏÉà ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
<button type="button" class="btn-success" onclick="addKeywordFromInput()">Ï∂îÍ∞Ä</button>
<button type="button" class="btn-secondary" onclick="cancelKeywordInput()">Ï∑®ÏÜå</button>
</div>
</div>
</div>
<div class="products-list" id="productsList">
<div class="empty-state">
<h3>üì¶ ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§</h3>
<p>ÏúÑÏùò "ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨<br>Ï≤´ Î≤àÏß∏ ÌÇ§ÏõåÎìúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
</div>
</div>
</div>
<div class="detail-panel">
<div class="detail-header">
<h2 id="currentProductTitle">ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</h2>
<p id="currentProductSubtitle">ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú ÏÉÅÌíàÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ìé∏ÏßëÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.</p>
</div>

<!-- üöÄ ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº ÏòÅÏó≠ -->
<div class="top-navigation" id="topNavigation" style="display: none;">
<div class="nav-buttons">
<div class="nav-buttons-left">
<button type="button" class="btn btn-secondary" onclick="previousProduct()">‚¨ÖÔ∏è Ïù¥Ï†Ñ</button>
<button type="button" class="btn btn-success" onclick="saveCurrentProduct()">üíæ Ï†ÄÏû•</button>
<button type="button" class="btn btn-secondary" onclick="nextProduct()">Îã§Ïùå ‚û°Ô∏è</button>
<button type="button" class="btn btn-primary" onclick="completeProduct()">‚úÖ ÏôÑÎ£å</button>
</div>
<div class="nav-divider"></div>
<div class="nav-buttons-right">
<button type="button" class="btn-orange" onclick="publishNow()" id="publishNowBtn">üöÄ Ï¶âÏãú Î∞úÌñâ</button>
</div>
</div>
</div>

<div id="productDetailContent" style="display: none;">
<div class="product-url-section">
<h3>üåè ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ ÏÉÅÌíà URL</h3>
<div class="url-input-group">
<input type="url" id="productUrl" placeholder="Ïòà: https://www.aliexpress.com/item/123456789.html">
<button type="button" class="btn btn-primary" onclick="analyzeProduct()">üîç Î∂ÑÏÑù</button>
</div>
<div class="analysis-result" id="analysisResult">
<div class="product-card" id="productCard"></div>
<div class="html-source-section" id="htmlSourceSection" style="display: none;">
<div class="html-source-header">
<h4>üìù ÏõåÎìúÌîÑÎ†àÏä§ Í∏Ä HTML ÏÜåÏä§</h4>
<button type="button" class="copy-btn" onclick="copyHtmlSource()">üìã Î≥µÏÇ¨ÌïòÍ∏∞</button>
</div>
<div class="html-preview">
<h5 style="margin: 0 0 10px 0; color: #666;">ÎØ∏Î¶¨Î≥¥Í∏∞:</h5>
<div id="htmlPreview"></div>
</div>
<div class="html-code" id="htmlCode"></div>
</div>
</div>
</div>
<div class="user-input-section">
<div class="input-group">
<h3>‚öôÔ∏è Í∏∞Îä• Î∞è Ïä§Ìéô <small style="color: #666;">(ÏÑ†ÌÉùÏÇ¨Ìï≠ - Îπà Ïπ∏ÏùÄ ÏûêÎèô Ï†úÏô∏)</small></h3>
<div class="form-row">
<div class="form-field">
<label>Ï£ºÏöî Í∏∞Îä•</label>
<input type="text" id="main_function" placeholder="Ïòà: ÏûêÎèô ÏïïÏ∂ï, Î¨º Ï†àÏïΩ, ÏãúÍ∞Ñ Îã®Ï∂ï Îì±">
</div>
</div>
<div class="form-row two-col">
<div class="form-field">
<label>ÌÅ¨Í∏∞/Ïö©Îüâ</label>
<input type="text" id="size_capacity" placeholder="Ïòà: 30cm √ó 20cm, 500ml Îì±">
</div>
<div class="form-field">
<label>ÏÉâÏÉÅ</label>
<input type="text" id="color" placeholder="Ïòà: ÌôîÏù¥Ìä∏, Î∏îÎûô, Ïã§Î≤Ñ Îì±">
</div>
</div>
<div class="form-row two-col">
<div class="form-field">
<label>Ïû¨Ïßà/ÏÜåÏû¨</label>
<input type="text" id="material" placeholder="Ïòà: Ïä§ÌÖåÏù∏Î¶¨Ïä§ Ïä§Ìã∏, Ïã§Î¶¨ÏΩò Îì±">
</div>
<div class="form-field">
<label>Ï†ÑÏõê/Î∞∞ÌÑ∞Î¶¨</label>
<input type="text" id="power_battery" placeholder="Ïòà: USB Ï∂©Ï†Ñ, Í±¥Ï†ÑÏßÄ Îì±">
</div>
</div>
</div>
<div class="input-group">
<h3>üìä Ìö®Ïú®ÏÑ± Î∂ÑÏÑù <small style="color: #666;">(ÏÑ†ÌÉùÏÇ¨Ìï≠ - Îπà Ïπ∏ÏùÄ ÏûêÎèô Ï†úÏô∏)</small></h3>
<div class="form-row">
<div class="form-field">
<label>Ìï¥Í≤∞ÌïòÎäî Î¨∏Ï†ú</label>
<input type="text" id="problem_solving" placeholder="Ïòà: ÏÑ§Í±∞ÏßÄ ÏãúÍ∞Ñ Ïò§Îûò Í±∏Î¶º">
</div>
</div>
<div class="form-row two-col">
<div class="form-field">
<label>ÏãúÍ∞Ñ Ï†àÏïΩ Ìö®Í≥º</label>
<input type="text" id="time_saving" placeholder="Ïòà: Í∏∞Ï°¥ 10Î∂Ñ ‚Üí 3Î∂ÑÏúºÎ°ú Îã®Ï∂ï">
</div>
<div class="form-field">
<label>Í≥µÍ∞Ñ ÌôúÏö©</label>
<input type="text" id="space_efficiency" placeholder="Ïòà: 50% Í≥µÍ∞Ñ Ï†àÏïΩ">
</div>
</div>
<div class="form-row">
<div class="form-field">
<label>ÎπÑÏö© Ï†àÍ∞ê</label>
<input type="text" id="cost_saving" placeholder="Ïòà: Ïõî Ï†ÑÍ∏∞Î£å 30% Ï†àÏïΩ">
</div>
</div>
</div>
<div class="input-group">
<h3>üè† ÏÇ¨Ïö© ÏãúÎÇòÎ¶¨Ïò§ <small style="color: #666;">(ÏÑ†ÌÉùÏÇ¨Ìï≠ - Îπà Ïπ∏ÏùÄ ÏûêÎèô Ï†úÏô∏)</small></h3>
<div class="form-row two-col">
<div class="form-field">
<label>Ï£ºÏöî ÏÇ¨Ïö© Ïû•ÏÜå</label>
<input type="text" id="usage_location" placeholder="Ïòà: Ï£ºÎ∞©, ÏöïÏã§, Í±∞Ïã§ Îì±">
</div>
<div class="form-field">
<label>ÏÇ¨Ïö© ÎπàÎèÑ</label>
<input type="text" id="usage_frequency" placeholder="Ïòà: Îß§Ïùº, Ï£º 2-3Ìöå Îì±">
</div>
</div>
<div class="form-row two-col">
<div class="form-field">
<label>Ï†ÅÌï©Ìïú ÏÇ¨Ïö©Ïûê</label>
<input type="text" id="target_users" placeholder="Ïòà: 1Ïù∏ Í∞ÄÍµ¨, ÎßûÎ≤åÏù¥ Î∂ÄÎ∂Ä Îì±">
</div>
<div class="form-field">
<label>ÏÇ¨Ïö©Î≤ï ÏöîÏïΩ</label>
<input type="text" id="usage_method" placeholder="Í∞ÑÎã®Ìïú ÏÇ¨Ïö© Îã®Í≥Ñ">
</div>
</div>
</div>
<div class="input-group">
<h3>‚úÖ Ïû•Ï†ê Î∞è Ï£ºÏùòÏÇ¨Ìï≠ <small style="color: #666;">(ÏÑ†ÌÉùÏÇ¨Ìï≠ - Îπà Ïπ∏ÏùÄ ÏûêÎèô Ï†úÏô∏)</small></h3>
<div class="form-row">
<div class="form-field">
<label>ÌïµÏã¨ Ïû•Ï†ê 3Í∞ÄÏßÄ</label>
<ol class="advantages-list">
<li><input type="text" id="advantage1" placeholder="Ïòà: ÏÑ§Ïπò Í∞ÑÌé∏Ìï®"></li>
<li><input type="text" id="advantage2" placeholder="Ïòà: Ïú†ÏßÄÎπÑ Ï†ÄÎ†¥Ìï®"></li>
<li><input type="text" id="advantage3" placeholder="Ïòà: ÎÇ¥Íµ¨ÏÑ± Îõ∞Ïñ¥ÎÇ®"></li>
</ol>
</div>
</div>
<div class="form-row">
<div class="form-field">
<label>Ï£ºÏùòÏÇ¨Ìï≠</label>
<textarea id="precautions" placeholder="Ïòà: Î¨ºÍ∏∞ Ï£ºÏùò, Ï†ïÍ∏∞ Ï≤≠ÏÜå ÌïÑÏöî Îì±"></textarea>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
let keywords = []; let currentKeywordIndex = -1; let currentProductIndex = -1; let currentProductData = null;
document.addEventListener('DOMContentLoaded', function() { updateUI(); handleScrollToTop(); });

// üîù ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô Î≤ÑÌäº Í¥ÄÎ†® Ìï®Ïàò
function handleScrollToTop() {
    const scrollBtn = document.getElementById('scrollToTop');
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            scrollBtn.classList.add('show');
        } else {
            scrollBtn.classList.remove('show');
        }
    });
}

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

function formatPrice(price) { if (!price) return price; return price.replace(/‚Ç©(\d)/, '‚Ç© $1'); }

function showDetailedError(title, message, debugData = null) {
    const existingModal = document.getElementById('errorModal');
    if (existingModal) { existingModal.remove(); }
    let fullMessage = message;
    if (debugData) { fullMessage += '\n\n=== ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ ===\n'; fullMessage += JSON.stringify(debugData, null, 2); }
    const modal = document.createElement('div'); modal.id = 'errorModal';
    modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;`;
    modal.innerHTML = `<div style="background: white; border-radius: 10px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);"><h2 style="color: #dc3545; margin-bottom: 20px; font-size: 24px;">üö® ${title}</h2><div style="margin-bottom: 20px;"><textarea id="errorContent" readonly style="width: 100%; height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; background: #f8f9fa; resize: vertical;">${fullMessage}</textarea></div><div style="display: flex; gap: 10px; justify-content: flex-end;"><button onclick="copyErrorToClipboard()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">üìã Î≥µÏÇ¨ÌïòÍ∏∞</button><button onclick="closeErrorModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Îã´Í∏∞</button></div></div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', function(e) { if (e.target === modal) { closeErrorModal(); } });
}

function copyErrorToClipboard() {
    const errorContent = document.getElementById('errorContent'); errorContent.select(); document.execCommand('copy');
    const copyBtn = event.target; const originalText = copyBtn.textContent; copyBtn.textContent = '‚úÖ Î≥µÏÇ¨Îê®!'; copyBtn.style.background = '#28a745';
    setTimeout(() => { copyBtn.textContent = originalText; copyBtn.style.background = '#007bff'; }, 2000);
}

function closeErrorModal() { const modal = document.getElementById('errorModal'); if (modal) { modal.remove(); } }
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeErrorModal(); } });

function toggleTitleGenerator() { const generator = document.getElementById('titleGenerator'); generator.style.display = generator.style.display === 'none' ? 'block' : 'none'; }

async function generateTitles() {
    const keywordsInput = document.getElementById('titleKeyword').value.trim();
    if (!keywordsInput) { showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
    const loading = document.getElementById('titleLoading'); const titlesDiv = document.getElementById('generatedTitles');
    loading.style.display = 'block'; titlesDiv.style.display = 'none';
    try {
        const formData = new FormData(); formData.append('action', 'generate_titles'); formData.append('keywords', keywordsInput);
        const response = await fetch('', { method: 'POST', body: formData }); const result = await response.json();
        if (result.success) { displayTitles(result.titles); } else { showDetailedError('Ï†úÎ™© ÏÉùÏÑ± Ïã§Ìå®', result.message); }
    } catch (error) { showDetailedError('Ï†úÎ™© ÏÉùÏÑ± Ïò§Î•ò', 'Ï†úÎ™© ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', { 'error': error.message, 'keywords': keywordsInput }); }
    finally { loading.style.display = 'none'; }
}

function displayTitles(titles) {
    const optionsDiv = document.getElementById('titleOptions'); const titlesDiv = document.getElementById('generatedTitles');
    optionsDiv.innerHTML = ''; titles.forEach((title) => { const button = document.createElement('button'); button.type = 'button'; button.className = 'title-option'; button.textContent = title; button.onclick = () => selectTitle(title); optionsDiv.appendChild(button); });
    titlesDiv.style.display = 'block';
}

function selectTitle(title) { document.getElementById('title').value = title; document.getElementById('titleGenerator').style.display = 'none'; }

function toggleKeywordInput() {
    const inputSection = document.getElementById('keywordInputSection'); const isVisible = inputSection.classList.contains('show');
    if (isVisible) { inputSection.classList.remove('show'); } else { inputSection.classList.add('show'); document.getElementById('newKeywordInput').focus(); }
}

function addKeywordFromInput() {
    const input = document.getElementById('newKeywordInput'); const name = input.value.trim();
    if (name) { const keyword = { name: name, products: [] }; keywords.push(keyword); updateUI(); input.value = ''; document.getElementById('keywordInputSection').classList.remove('show'); addProduct(keywords.length - 1); } else { showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); }
}

function cancelKeywordInput() { const input = document.getElementById('newKeywordInput'); input.value = ''; document.getElementById('keywordInputSection').classList.remove('show'); }

document.addEventListener('DOMContentLoaded', function() { document.getElementById('newKeywordInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); addKeywordFromInput(); } }); });

function addKeyword() { toggleKeywordInput(); }

function addProduct(keywordIndex) {
    const product = { id: Date.now() + Math.random(), url: '', name: `ÏÉÅÌíà ${keywords[keywordIndex].products.length + 1}`, status: 'empty', analysisData: null, userData: {}, isSaved: false, generatedHtml: null }; // üîß generatedHtml ÏÜçÏÑ± Ï∂îÍ∞Ä
    keywords[keywordIndex].products.push(product); updateUI(); selectProduct(keywordIndex, keywords[keywordIndex].products.length - 1);
}

// üöÄ ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌÇ§ÏõåÎìú ÏÇ≠Ï†ú Ìï®Ïàò
function deleteKeyword(keywordIndex) {
    if (confirm(`"${keywords[keywordIndex].name}" ÌÇ§ÏõåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÌÇ§ÏõåÎìúÏóê Ìè¨Ìï®Îêú Î™®Îì† ÏÉÅÌíàÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) {
        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌÇ§ÏõåÎìúÍ∞Ä ÏÇ≠Ï†úÎêòÎäî Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
        if (currentKeywordIndex === keywordIndex) {
            currentKeywordIndex = -1;
            currentProductIndex = -1;
            document.getElementById('topNavigation').style.display = 'none';
            document.getElementById('productDetailContent').style.display = 'none';
            document.getElementById('currentProductTitle').textContent = 'ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî';
            document.getElementById('currentProductSubtitle').textContent = 'ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú ÏÉÅÌíàÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ìé∏ÏßëÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.';
        } else if (currentKeywordIndex > keywordIndex) {
            // ÏÇ≠Ï†úÎêú ÌÇ§ÏõåÎìúÎ≥¥Îã§ Îí§Ïóê ÏûàÎäî ÌÇ§ÏõåÎìúÍ∞Ä ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ Ïù∏Îç±Ïä§ Ï°∞Ï†ï
            currentKeywordIndex--;
        }
        
        keywords.splice(keywordIndex, 1);
        updateUI();
    }
}

// üöÄ ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÏÉÅÌíà ÏÇ≠Ï†ú Ìï®Ïàò
function deleteProduct(keywordIndex, productIndex) {
    const product = keywords[keywordIndex].products[productIndex];
    if (confirm(`"${product.name}" ÏÉÅÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÎäî Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
        if (currentKeywordIndex === keywordIndex && currentProductIndex === productIndex) {
            currentKeywordIndex = -1;
            currentProductIndex = -1;
            document.getElementById('topNavigation').style.display = 'none';
            document.getElementById('productDetailContent').style.display = 'none';
            document.getElementById('currentProductTitle').textContent = 'ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî';
            document.getElementById('currentProductSubtitle').textContent = 'ÏôºÏ™Ω Î™©Î°ùÏóêÏÑú ÏÉÅÌíàÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ìé∏ÏßëÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.';
        } else if (currentKeywordIndex === keywordIndex && currentProductIndex > productIndex) {
            // Í∞ôÏùÄ ÌÇ§ÏõåÎìúÏùò Îí§Ïóê ÏûàÎäî ÏÉÅÌíàÏù¥ ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ Ïù∏Îç±Ïä§ Ï°∞Ï†ï
            currentProductIndex--;
        }
        
        keywords[keywordIndex].products.splice(productIndex, 1);
        updateUI();
    }
}

// üîß ÏÉàÎ°úÏö¥ ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî Ìï®Ïàò
function clearUserInputFields() {
    // Í∏∞Îä• Î∞è Ïä§Ìéô Ï¥àÍ∏∞Ìôî
    document.getElementById('main_function').value = '';
    document.getElementById('size_capacity').value = '';
    document.getElementById('color').value = '';
    document.getElementById('material').value = '';
    document.getElementById('power_battery').value = '';
    
    // Ìö®Ïú®ÏÑ± Î∂ÑÏÑù Ï¥àÍ∏∞Ìôî
    document.getElementById('problem_solving').value = '';
    document.getElementById('time_saving').value = '';
    document.getElementById('space_efficiency').value = '';
    document.getElementById('cost_saving').value = '';
    
    // ÏÇ¨Ïö© ÏãúÎÇòÎ¶¨Ïò§ Ï¥àÍ∏∞Ìôî
    document.getElementById('usage_location').value = '';
    document.getElementById('usage_frequency').value = '';
    document.getElementById('target_users').value = '';
    document.getElementById('usage_method').value = '';
    
    // Ïû•Ï†ê Î∞è Ï£ºÏùòÏÇ¨Ìï≠ Ï¥àÍ∏∞Ìôî
    document.getElementById('advantage1').value = '';
    document.getElementById('advantage2').value = '';
    document.getElementById('advantage3').value = '';
    document.getElementById('precautions').value = '';
}

// üîß Ï†ÄÏû•Îêú ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÌïÑÎìú Î°úÎìú Ìï®Ïàò
function loadUserInputFields(userData) {
    if (!userData) return;
    
    // Í∏∞Îä• Î∞è Ïä§Ìéô Î°úÎìú
    if (userData.specs) {
        document.getElementById('main_function').value = userData.specs.main_function || '';
        document.getElementById('size_capacity').value = userData.specs.size_capacity || '';
        document.getElementById('color').value = userData.specs.color || '';
        document.getElementById('material').value = userData.specs.material || '';
        document.getElementById('power_battery').value = userData.specs.power_battery || '';
    }
    
    // Ìö®Ïú®ÏÑ± Î∂ÑÏÑù Î°úÎìú
    if (userData.efficiency) {
        document.getElementById('problem_solving').value = userData.efficiency.problem_solving || '';
        document.getElementById('time_saving').value = userData.efficiency.time_saving || '';
        document.getElementById('space_efficiency').value = userData.efficiency.space_efficiency || '';
        document.getElementById('cost_saving').value = userData.efficiency.cost_saving || '';
    }
    
    // ÏÇ¨Ïö© ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú
    if (userData.usage) {
        document.getElementById('usage_location').value = userData.usage.usage_location || '';
        document.getElementById('usage_frequency').value = userData.usage.usage_frequency || '';
        document.getElementById('target_users').value = userData.usage.target_users || '';
        document.getElementById('usage_method').value = userData.usage.usage_method || '';
    }
    
    // Ïû•Ï†ê Î∞è Ï£ºÏùòÏÇ¨Ìï≠ Î°úÎìú
    if (userData.benefits) {
        if (userData.benefits.advantages) {
            document.getElementById('advantage1').value = userData.benefits.advantages[0] || '';
            document.getElementById('advantage2').value = userData.benefits.advantages[1] || '';
            document.getElementById('advantage3').value = userData.benefits.advantages[2] || '';
        }
        document.getElementById('precautions').value = userData.benefits.precautions || '';
    }
}

function selectProduct(keywordIndex, productIndex) {
    currentKeywordIndex = keywordIndex; currentProductIndex = productIndex; const product = keywords[keywordIndex].products[productIndex];
    document.querySelectorAll('.product-item').forEach(item => { item.classList.remove('active'); });
    const selectedItem = document.querySelector(`[data-keyword="${keywordIndex}"][data-product="${productIndex}"]`);
    if (selectedItem) { selectedItem.classList.add('active'); } 
    updateDetailPanel(product);
    
    // üöÄ ÏÉÅÌíà ÏÑ†ÌÉù Ïãú ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌëúÏãú
    document.getElementById('topNavigation').style.display = 'block';
}

function updateDetailPanel(product) {
    const titleEl = document.getElementById('currentProductTitle'); const subtitleEl = document.getElementById('currentProductSubtitle');
    const contentEl = document.getElementById('productDetailContent'); const urlInput = document.getElementById('productUrl');
    titleEl.textContent = product.name; subtitleEl.textContent = `ÌÇ§ÏõåÎìú: ${keywords[currentKeywordIndex].name}`; urlInput.value = product.url || '';
    
    // üîß ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî ÎòêÎäî Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    if (product.userData && Object.keys(product.userData).length > 0) {
        // Í∏∞Ï°¥Ïóê Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Î°úÎìú
        loadUserInputFields(product.userData);
    } else {
        // ÏÉà ÏÉÅÌíàÏù¥Î©¥ Î™®Îì† ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        clearUserInputFields();
    }
    
    if (product.analysisData) { showAnalysisResult(product.analysisData); } else { hideAnalysisResult(); } contentEl.style.display = 'block';
}

async function analyzeProduct() {
    const url = document.getElementById('productUrl').value.trim();
    if (!url) { showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'ÏÉÅÌíà URLÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
    if (currentKeywordIndex === -1 || currentProductIndex === -1) { showDetailedError('ÏÑ†ÌÉù Ïò§Î•ò', 'ÏÉÅÌíàÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'); return; }
    const product = keywords[currentKeywordIndex].products[currentProductIndex];
    product.url = url; product.status = 'analyzing'; updateUI();
    try {
        const response = await fetch('product_analyzer_v2.php', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ action: 'analyze_product', url: url, platform: 'aliexpress' }) });
        if (!response.ok) { throw new Error(`HTTP Ïò§Î•ò: ${response.status} ${response.statusText}`); }
        const responseText = await response.text(); let result;
        try { result = JSON.parse(responseText); } catch (parseError) { showDetailedError('JSON ÌååÏã± Ïò§Î•ò', 'ÏÑúÎ≤Ñ ÏùëÎãµÏùÑ ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', { 'parseError': parseError.message, 'responseText': responseText, 'responseLength': responseText.length, 'url': url, 'timestamp': new Date().toISOString() }); product.status = 'error'; updateUI(); return; }
        if (result.success) { 
            product.analysisData = result.data; 
            product.status = 'completed'; 
            product.name = result.data.title || `ÏÉÅÌíà ${currentProductIndex + 1}`; 
            currentProductData = result.data; 
            showAnalysisResult(result.data); 
            
            // üîß HTML ÏÉùÏÑ± Î∞è Ï†ÄÏû•
            const generatedHtml = generateOptimizedMobileHtml(result.data);
            product.generatedHtml = generatedHtml;
            console.log('Generated HTML saved to product:', generatedHtml);
        } else { 
            product.status = 'error'; 
            showDetailedError('ÏÉÅÌíà Î∂ÑÏÑù Ïã§Ìå®', result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', { 'success': result.success, 'message': result.message, 'debug_info': result.debug_info || null, 'raw_output': result.raw_output || null, 'url': url, 'platform': 'aliexpress', 'timestamp': new Date().toISOString(), 'mobile_optimized': true }); 
        }
    } catch (error) { product.status = 'error'; showDetailedError('ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò', 'ÏÉÅÌíà Î∂ÑÏÑù Ï§ë ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', { 'error': error.message, 'stack': error.stack, 'url': url, 'timestamp': new Date().toISOString() }); }
    updateUI();
}

function showAnalysisResult(data) {
    const resultEl = document.getElementById('analysisResult'); const cardEl = document.getElementById('productCard');
    const ratingDisplay = data.rating_display ? data.rating_display.replace(/‚≠ê/g, '').replace(/[()]/g, '').trim() : 'Ï†ïÎ≥¥ ÏóÜÏùå';
    const formattedPrice = formatPrice(data.price);
    cardEl.innerHTML = `<div class="product-content-split"><div class="product-image-large"><img src="${data.image_url}" alt="${data.title}" onerror="this.style.display='none'"></div><div class="product-info-all"><div class="aliexpress-logo-right"><img src="https://novacents.com/tools/images/Ali_black_logo.webp" alt="AliExpress" /></div><h3 class="product-title-right">${data.title}</h3><div class="product-price-right">${formattedPrice}</div><div class="product-rating-right"><span class="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span><span>(Í≥†Í∞ùÎßåÏ°±ÎèÑ: ${ratingDisplay})</span></div><div class="product-sales-right"><strong>üì¶ ÌåêÎß§Îüâ:</strong> ${data.lastest_volume || 'ÌåêÎß§Îüâ Ï†ïÎ≥¥ ÏóÜÏùå'}</div><div class="product-extra-info-right"><div class="info-row"><span class="info-label">ÏÉÅÌíà ID</span><span class="info-value">${data.product_id}</span></div><div class="info-row"><span class="info-label">ÌîåÎû´Ìèº</span><span class="info-value">${data.platform}</span></div></div></div></div><div class="purchase-button-full"><a href="${data.affiliate_link}" target="_blank" rel="nofollow"><picture><source media="(max-width: 1600px)" srcset="https://novacents.com/tools/images/aliexpress-button-mobile.png"><img src="https://novacents.com/tools/images/aliexpress-button-pc.png" alt="ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ÏóêÏÑú Íµ¨Îß§ÌïòÍ∏∞"></picture></a></div>`;
    resultEl.classList.add('show');
}

// üîß ÏàòÏ†ïÎêú HTML ÏÉùÏÑ± Ìï®Ïàò - HTML Î∞òÌôòÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω
function generateOptimizedMobileHtml(data) {
    if (!data) return null;
    const ratingDisplay = data.rating_display ? data.rating_display.replace(/‚≠ê/g, '').replace(/[()]/g, '').trim() : 'Ï†ïÎ≥¥ ÏóÜÏùå';
    const formattedPrice = formatPrice(data.price);
    const htmlCode = `<div style="display: flex; justify-content: center; margin: 25px 0;">
    <div style="border: 2px solid #eee; padding: 30px; border-radius: 15px; background: #f9f9f9; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 1000px; width: 100%;">
        
        <div style="display: grid; grid-template-columns: 400px 1fr; gap: 30px; align-items: start; margin-bottom: 25px;">
            <div style="text-align: center;">
                <img src="${data.image_url}" alt="${data.title}" style="width: 100%; max-width: 400px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15);">
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div style="margin-bottom: 15px; text-align: center;">
                    <img src="https://novacents.com/tools/images/Ali_black_logo.webp" alt="AliExpress" style="width: 250px; height: 60px; object-fit: contain;" />
                </div>
                
                <h3 style="color: #1c1c1c; margin: 0 0 20px 0; font-size: 21px; font-weight: 600; line-height: 1.4; word-break: keep-all; overflow-wrap: break-word; text-align: center;">${data.title}</h3>
                
                <div style="background: linear-gradient(135deg, #e62e04 0%, #ff9900 100%); color: white; padding: 14px 30px; border-radius: 10px; font-size: 40px; font-weight: 700; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(230, 46, 4, 0.3);">
                    <strong>${formattedPrice}</strong>
                </div>
                
                <div style="color: #1c1c1c; font-size: 20px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; justify-content: center; flex-wrap: nowrap;">
                    <span style="color: #ff9900;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                    <span>(Í≥†Í∞ùÎßåÏ°±ÎèÑ: ${ratingDisplay})</span>
                </div>
                
                <p style="color: #1c1c1c; font-size: 18px; margin: 0 0 15px 0; text-align: center;"><strong>üì¶ ÌåêÎß§Îüâ:</strong> ${data.lastest_volume || 'ÌåêÎß§Îüâ Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; width: 100%;">
            <a href="${data.affiliate_link}" target="_blank" rel="nofollow" style="text-decoration: none;">
                <picture>
                    <source media="(max-width: 1600px)" srcset="https://novacents.com/tools/images/aliexpress-button-mobile.png">
                    <img src="https://novacents.com/tools/images/aliexpress-button-pc.png" 
                         alt="ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ÏóêÏÑú Íµ¨Îß§ÌïòÍ∏∞" 
                         style="max-width: 100%; height: auto; cursor: pointer;">
                </picture>
            </a>
        </div>
    </div>
</div>

<style>
@media (max-width: 1600px) {
    div[style*="grid-template-columns: 400px 1fr"] {
        display: block !important;
        grid-template-columns: none !important;
        gap: 15px !important;
    }
    
    img[style*="max-width: 400px"] {
        width: 95% !important;
        max-width: none !important;
        margin-bottom: 30px !important;
    }
    
    div[style*="gap: 20px"] {
        gap: 10px !important;
    }
    
    div[style*="text-align: center"] img[alt="AliExpress"] {
        display: block;
        margin: 0 !important;
    }
    div[style*="text-align: center"]:has(img[alt="AliExpress"]) {
        text-align: left !important;
        margin-bottom: 10px !important;
    }
    
    h3[style*="text-align: center"] {
        text-align: left !important;
        font-size: 18px !important;
        margin-bottom: 10px !important;
    }
    
    div[style*="font-size: 40px"] {
        font-size: 28px !important;
        padding: 12px 20px !important;
        margin-bottom: 10px !important;
    }
    
    div[style*="justify-content: center"][style*="flex-wrap: nowrap"] {
        justify-content: flex-start !important;
        font-size: 16px !important;
        margin-bottom: 10px !important;
        gap: 8px !important;
    }
    
    p[style*="text-align: center"] {
        text-align: left !important;
        font-size: 16px !important;
        margin-bottom: 10px !important;
    }
    
    div[style*="margin-top: 30px"] {
        margin-top: 15px !important;
    }
}

@media (max-width: 480px) {
    img[style*="width: 95%"] {
        width: 100% !important;
    }
    
    h3[style*="font-size: 18px"] {
        font-size: 16px !important;
    }
    
    div[style*="font-size: 28px"] {
        font-size: 24px !important;
    }
}
</style>`;
    
    const previewHtml = `<div class="preview-product-card"><div class="preview-card-content"><div class="product-content-split"><div class="product-image-large"><img src="${data.image_url}" alt="${data.title}" onerror="this.style.display='none'"></div><div class="product-info-all"><div class="aliexpress-logo-right"><img src="https://novacents.com/tools/images/Ali_black_logo.webp" alt="AliExpress" /></div><h3 class="product-title-right">${data.title}</h3><div class="product-price-right">${formattedPrice}</div><div class="product-rating-right"><span class="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span><span>(Í≥†Í∞ùÎßåÏ°±ÎèÑ: ${ratingDisplay})</span></div><div class="product-sales-right"><strong>üì¶ ÌåêÎß§Îüâ:</strong> ${data.lastest_volume || 'ÌåêÎß§Îüâ Ï†ïÎ≥¥ ÏóÜÏùå'}</div></div></div><div class="purchase-button-full"><a href="${data.affiliate_link}" target="_blank" rel="nofollow"><picture><source media="(max-width: 1600px)" srcset="https://novacents.com/tools/images/aliexpress-button-mobile.png"><img src="https://novacents.com/tools/images/aliexpress-button-pc.png" alt="ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ÏóêÏÑú Íµ¨Îß§ÌïòÍ∏∞"></picture></a></div></div></div>`;
    document.getElementById('htmlPreview').innerHTML = previewHtml; 
    document.getElementById('htmlCode').textContent = htmlCode; 
    document.getElementById('htmlSourceSection').style.display = 'block';
    
    // üîß ÏÉùÏÑ±Îêú HTML Î∞òÌôò
    return htmlCode;
}

async function copyHtmlSource() {
    const htmlCode = document.getElementById('htmlCode').textContent; const copyBtn = document.querySelector('.copy-btn');
    try { await navigator.clipboard.writeText(htmlCode); const originalText = copyBtn.textContent; copyBtn.textContent = '‚úÖ Î≥µÏÇ¨Îê®!'; copyBtn.classList.add('copied'); setTimeout(() => { copyBtn.textContent = originalText; copyBtn.classList.remove('copied'); }, 2000); } catch (error) { const codeEl = document.getElementById('htmlCode'); const range = document.createRange(); range.selectNodeContents(codeEl); const selection = window.getSelection(); selection.removeAllRanges(); selection.addRange(range); showDetailedError('Î≥µÏÇ¨ ÏïåÎ¶º', 'HTML ÏÜåÏä§Í∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§. Ctrl+CÎ°ú Î≥µÏÇ¨ÌïòÏÑ∏Ïöî.'); }
}

function hideAnalysisResult() { const resultEl = document.getElementById('analysisResult'); resultEl.classList.remove('show'); document.getElementById('htmlSourceSection').style.display = 'none'; }

function updateUI() { updateProductsList(); updateProgress(); }

function updateProductsList() {
    const listEl = document.getElementById('productsList');
    if (keywords.length === 0) { listEl.innerHTML = `<div class="empty-state"><h3>üì¶ ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§</h3><p>ÏúÑÏùò "ÌÇ§ÏõåÎìú Ï∂îÍ∞Ä" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨<br>Ï≤´ Î≤àÏß∏ ÌÇ§ÏõåÎìúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p></div>`; return; }
    let html = ''; 
    keywords.forEach((keyword, keywordIndex) => { 
        html += `<div class="keyword-group">
            <div class="keyword-header">
                <div class="keyword-info">
                    <span class="keyword-name">üìÅ ${keyword.name}</span>
                    <span class="product-count">${keyword.products.length}Í∞ú</span>
                </div>
                <div class="keyword-actions">
                    <button type="button" class="btn btn-success btn-small" onclick="addProduct(${keywordIndex})">+ÏÉÅÌíà</button>
                    <button type="button" class="btn btn-danger btn-small" onclick="deleteKeyword(${keywordIndex})">üóëÔ∏è</button>
                </div>
            </div>`; 
        keyword.products.forEach((product, productIndex) => { 
            const statusIcon = getStatusIcon(product.status, product.isSaved); 
            html += `<div class="product-item" data-keyword="${keywordIndex}" data-product="${productIndex}" onclick="selectProduct(${keywordIndex}, ${productIndex})">
                <span class="product-status">${statusIcon}</span>
                <span class="product-name">${product.name}</span>
                <div class="product-actions">
                    <button type="button" class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteProduct(${keywordIndex}, ${productIndex})">üóëÔ∏è</button>
                </div>
            </div>`; 
        }); 
        html += '</div>'; 
    }); 
    listEl.innerHTML = html;
}

// üîß ÏàòÏ†ïÎêú ÏÉÅÌÉú ÏïÑÏù¥ÏΩò Ìï®Ïàò - Ï†ÄÏû• Ïó¨Î∂ÄÍπåÏßÄ Í≥†Î†§
function getStatusIcon(status, isSaved = false) { 
    switch (status) { 
        case 'completed': 
            return isSaved ? '‚úÖ' : 'üîç'; // Î∂ÑÏÑù ÏôÑÎ£å + Ï†ÄÏû•Îê® = ‚úÖ, Î∂ÑÏÑùÎßå ÏôÑÎ£å = üîç
        case 'analyzing': 
            return 'üîÑ'; 
        case 'error': 
            return '‚ö†Ô∏è'; 
        default: 
            return '‚ùå'; 
    } 
}

// üîß ÏàòÏ†ïÎêú ÏßÑÌñâÎ•† Í≥ÑÏÇ∞ Ìï®Ïàò - Ï†ÄÏû•Îêú ÏÉÅÌíàÎßå ÏôÑÎ£åÎ°ú Ïù∏Ï†ï
function updateProgress() {
    const totalProducts = keywords.reduce((sum, keyword) => sum + keyword.products.length, 0);
    const completedProducts = keywords.reduce((sum, keyword) => sum + keyword.products.filter(p => p.isSaved).length, 0); // üîß isSavedÍ∞Ä trueÏù∏ ÏÉÅÌíàÎßå ÏôÑÎ£åÎ°ú Ïù∏Ï†ï
    const percentage = totalProducts > 0 ? (completedProducts / totalProducts) * 100 : 0;
    document.getElementById('progressFill').style.width = percentage + '%'; document.getElementById('progressText').textContent = `${completedProducts}/${totalProducts} ÏôÑÏÑ±`;
}

// üöÄ ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏàòÏßë Ìï®ÏàòÎì§
function collectUserInputDetails() {
    const details = {};
    
    // Í∏∞Îä• Î∞è Ïä§Ìéô
    const specs = {};
    addIfNotEmpty(specs, 'main_function', 'main_function');
    addIfNotEmpty(specs, 'size_capacity', 'size_capacity');
    addIfNotEmpty(specs, 'color', 'color');
    addIfNotEmpty(specs, 'material', 'material');
    addIfNotEmpty(specs, 'power_battery', 'power_battery');
    if (Object.keys(specs).length > 0) details.specs = specs;
    
    // Ìö®Ïú®ÏÑ± Î∂ÑÏÑù
    const efficiency = {};
    addIfNotEmpty(efficiency, 'problem_solving', 'problem_solving');
    addIfNotEmpty(efficiency, 'time_saving', 'time_saving');
    addIfNotEmpty(efficiency, 'space_efficiency', 'space_efficiency');
    addIfNotEmpty(efficiency, 'cost_saving', 'cost_saving');
    if (Object.keys(efficiency).length > 0) details.efficiency = efficiency;
    
    // ÏÇ¨Ïö© ÏãúÎÇòÎ¶¨Ïò§
    const usage = {};
    addIfNotEmpty(usage, 'usage_location', 'usage_location');
    addIfNotEmpty(usage, 'usage_frequency', 'usage_frequency');
    addIfNotEmpty(usage, 'target_users', 'target_users');
    addIfNotEmpty(usage, 'usage_method', 'usage_method');
    if (Object.keys(usage).length > 0) details.usage = usage;
    
    // Ïû•Ï†ê Î∞è Ï£ºÏùòÏÇ¨Ìï≠
    const benefits = {};
    const advantages = [];
    ['advantage1', 'advantage2', 'advantage3'].forEach(id => {
        const value = document.getElementById(id)?.value.trim();
        if (value) advantages.push(value);
    });
    if (advantages.length > 0) benefits.advantages = advantages;
    addIfNotEmpty(benefits, 'precautions', 'precautions');
    if (Object.keys(benefits).length > 0) details.benefits = benefits;
    
    return details;
}

function addIfNotEmpty(obj, key, elementId) {
    const value = document.getElementById(elementId)?.value.trim();
    if (value) obj[key] = value;
}

// üîß Í∞ïÌôîÎêú ÌÇ§ÏõåÎìú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®Ïàò - Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ÏôÄ HTMLÎèÑ Ìè¨Ìï®
function collectKeywordsData() {
    console.log('collectKeywordsData: Starting comprehensive keyword data collection...');
    const keywordsData = [];
    
    keywords.forEach((keyword, keywordIndex) => {
        console.log(`Processing keyword ${keywordIndex}: ${keyword.name}`);
        
        // keyword_processor.phpÍ∞Ä Í∏∞ÎåÄÌïòÎäî ÌòïÏãùÏúºÎ°ú Î≥ÄÍ≤Ω
        const keywordData = {
            name: keyword.name,
            coupang: [], // Ïø†Ìå° ÎßÅÌÅ¨ Î∞∞Ïó¥ (ÌòÑÏû¨Îäî ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå)
            aliexpress: [], // ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ ÎßÅÌÅ¨ Î∞∞Ïó¥
            products_data: [] // üîß ÏÉàÎ°ú Ï∂îÍ∞Ä: ÏÉÅÌíà Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ÏôÄ HTML Ï†ïÎ≥¥
        };
        
        // Í∞Å ÌÇ§ÏõåÎìúÏùò ÏÉÅÌíà URLÎì§Í≥º Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
        keyword.products.forEach((product, productIndex) => {
            console.log(`  Checking product ${productIndex}: "${product.url}"`);
            
            // üîß Îçî ÏóÑÍ≤©Ìïú URL Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (product.url && 
                typeof product.url === 'string' && 
                product.url.trim() !== '' && 
                product.url.trim() !== 'undefined' && 
                product.url.trim() !== 'null' &&
                product.url.includes('aliexpress.com')) {
                
                const trimmedUrl = product.url.trim();
                console.log(`    Valid URL found: ${trimmedUrl}`);
                keywordData.aliexpress.push(trimmedUrl);
                
                // üîß ÏÉÅÌíà Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ÏôÄ HTML ÏÜåÏä§ÎèÑ Ìï®Íªò ÏàòÏßë
                const productData = {
                    url: trimmedUrl,
                    analysis_data: product.analysisData || null,
                    generated_html: product.generatedHtml || null,
                    user_data: product.userData || {}
                };
                
                keywordData.products_data.push(productData);
                console.log(`    Product data collected:`, {
                    hasAnalysisData: !!product.analysisData,
                    hasGeneratedHtml: !!product.generatedHtml,
                    hasUserData: !!(product.userData && Object.keys(product.userData).length > 0)
                });
            } else {
                console.log(`    Invalid or empty URL skipped: "${product.url}"`);
            }
        });
        
        // Ïú†Ìö®Ìïú ÎßÅÌÅ¨Í∞Ä ÏûàÎäî ÌÇ§ÏõåÎìúÎßå Ï∂îÍ∞Ä
        if (keywordData.aliexpress.length > 0) {
            console.log(`  Keyword "${keyword.name}" added with ${keywordData.aliexpress.length} valid links and ${keywordData.products_data.length} product data entries`);
            keywordsData.push(keywordData);
        } else {
            console.log(`  Keyword "${keyword.name}" skipped - no valid links`);
        }
    });
    
    console.log('Final comprehensive keywords data:', keywordsData);
    console.log('Total keywords with valid data:', keywordsData.length);
    
    return keywordsData;
}

function validateAndSubmitData(formData, isPublishNow = false) {
    console.log('validateAndSubmitData: Starting validation...');
    console.log('Form data:', formData);
    
    // Í∏∞Î≥∏ Í≤ÄÏ¶ù
    if (!formData.title || formData.title.length < 5) {
        showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'Ï†úÎ™©ÏùÄ 5Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
        return false;
    }
    
    if (!formData.keywords || formData.keywords.length === 0) {
        showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'ÏµúÏÜå ÌïòÎÇòÏùò ÌÇ§ÏõåÎìúÏôÄ ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
        return false;
    }
    
    // Í∞Å ÌÇ§ÏõåÎìúÏóê Ïú†Ìö®Ìïú ÎßÅÌÅ¨Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
    let hasValidLinks = false;
    let totalValidLinks = 0;
    let totalProductsWithData = 0;
    
    formData.keywords.forEach(keyword => {
        if (keyword.aliexpress && keyword.aliexpress.length > 0) {
            // Îπà Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Ïã§Ï†ú URLÎßå Ïπ¥Ïö¥Ìä∏
            const validUrls = keyword.aliexpress.filter(url => 
                url && 
                typeof url === 'string' && 
                url.trim() !== '' && 
                url.includes('aliexpress.com')
            );
            
            if (validUrls.length > 0) {
                hasValidLinks = true;
                totalValidLinks += validUrls.length;
                totalProductsWithData += keyword.products_data ? keyword.products_data.length : 0;
                console.log(`Keyword "${keyword.name}" has ${validUrls.length} valid URLs and ${keyword.products_data ? keyword.products_data.length : 0} product data entries`);
            }
        }
    });
    
    if (!hasValidLinks || totalValidLinks === 0) {
        showDetailedError('ÏûÖÎ†• Ïò§Î•ò', 'Í∞Å ÌÇ§ÏõåÎìúÏóê ÏµúÏÜå ÌïòÎÇòÏùò Ïú†Ìö®Ìïú ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ ÏÉÅÌíà ÎßÅÌÅ¨Í∞Ä ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§.\n\nÌòÑÏû¨ ÏÉÅÌÉú:\n- URLÏùÑ ÏûÖÎ†•ÌñàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî\n- Î∂ÑÏÑù Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌñàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî\n- ÏïåÎ¶¨ÏùµÏä§ÌîÑÎ†àÏä§ URLÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî');
        return false;
    }
    
    console.log(`Validation passed! Total valid links: ${totalValidLinks}, Products with data: ${totalProductsWithData}`);
    
    if (isPublishNow) {
        // Ï¶âÏãú Î∞úÌñâÏö© AJAX Ï†ÑÏÜ°
        return true;
    } else {
        // Ìèº Îç∞Ïù¥ÌÑ∞Î•º hidden inputÏúºÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Ï†ÑÏÜ°
        const form = document.getElementById('affiliateForm');
        
        // Í∏∞Ï°¥ hidden input Ï†úÍ±∞
        const existingInputs = form.querySelectorAll('input[type="hidden"]');
        existingInputs.forEach(input => input.remove());
        
        // ÏÉàÎ°úÏö¥ hidden inputÎì§ Ï∂îÍ∞Ä
        const hiddenInputs = [
            { name: 'title', value: formData.title },
            { name: 'category', value: formData.category },
            { name: 'prompt_type', value: formData.prompt_type },
            { name: 'keywords', value: JSON.stringify(formData.keywords) },
            { name: 'user_details', value: JSON.stringify(formData.user_details) }
        ];
        
        hiddenInputs.forEach(({ name, value }) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        });
        
        console.log('Hidden inputs added, submitting form...');
        
        // Ìèº Ï†ÑÏÜ°
        form.submit();
        return true;
    }
}

// üîß ÏàòÏ†ïÎêú Î≤ÑÌäº Í∏∞Îä•Îì§

// üöÄ ÏÉàÎ°úÏö¥ Ï¶âÏãú Î∞úÌñâ Í∏∞Îä•
async function publishNow() {
    console.log('üöÄ Ï¶âÏãú Î∞úÌñâÏùÑ ÏãúÏûëÌï©ÎãàÎã§...');
    
    // 1. Í∏∞Ï°¥ ÌÇ§ÏõåÎìú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ÏôÄ HTML Ìè¨Ìï®)
    const keywordsData = collectKeywordsData();
    
    // 2. ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏàòÏßë (Îπà Í∞í Ï†úÏô∏)
    const userDetails = collectUserInputDetails();
    
    // 3. Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏàòÏßë (ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ Ï∂îÍ∞Ä)
    const formData = {
        title: document.getElementById('title').value.trim(),
        category: document.getElementById('category').value,
        prompt_type: document.getElementById('prompt_type').value,
        keywords: keywordsData,
        user_details: userDetails
    };
    
    console.log('Ï¶âÏãú Î∞úÌñâÏö© Ï¢ÖÌï© Îç∞Ïù¥ÌÑ∞:', formData);
    
    // 4. Í≤ÄÏ¶ù
    if (!validateAndSubmitData(formData, true)) {
        return;
    }
    
    // 5. Î°úÎî© ÌëúÏãú
    const loadingOverlay = document.getElementById('loadingOverlay');
    const publishBtn = document.getElementById('publishNowBtn');
    
    loadingOverlay.style.display = 'flex';
    publishBtn.disabled = true;
    publishBtn.textContent = 'Î∞úÌñâ Ï§ë...';
    
    try {
        // 6. Ï¶âÏãú Î∞úÌñâ ÏöîÏ≤≠ - keyword_processor.phpÎ°ú ÏßÅÏ†ë Ï†ÑÏÜ°
        const response = await fetch('keyword_processor.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                title: formData.title,
                category: formData.category,
                prompt_type: formData.prompt_type,
                keywords: JSON.stringify(formData.keywords),
                user_details: JSON.stringify(formData.user_details),
                publish_mode: 'immediate'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Í∏Ä Î∞úÌñâÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
            if (result.post_url) {
                window.open(result.post_url, '_blank');
            }
        } else {
            showDetailedError('Î∞úÌñâ Ïã§Ìå®', result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
        
    } catch (error) {
        showDetailedError('Î∞úÌñâ Ïò§Î•ò', 'Ï¶âÏãú Î∞úÌñâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', {
            'error': error.message,
            'timestamp': new Date().toISOString()
        });
    } finally {
        // 7. Î°úÎî© Ìï¥Ï†ú
        loadingOverlay.style.display = 'none';
        publishBtn.disabled = false;
        publishBtn.textContent = 'üöÄ Ï¶âÏãú Î∞úÌñâ';
    }
}

// üîß ÏàòÏ†ïÎêú Ï†ÄÏû• Í∏∞Îä• (ÌòÑÏû¨ ÏÉÅÌíàÎßå Ï†ÄÏû•) - isSaved ÌîåÎûòÍ∑∏ Ï∂îÍ∞Ä
function saveCurrentProduct() {
    if (currentKeywordIndex === -1 || currentProductIndex === -1) {
        showDetailedError('ÏÑ†ÌÉù Ïò§Î•ò', 'Ï†ÄÏû•Ìï† ÏÉÅÌíàÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }
    
    const product = keywords[currentKeywordIndex].products[currentProductIndex];
    
    // ÌòÑÏû¨ ÏÉÅÌíàÏùò URL ÏóÖÎç∞Ïù¥Ìä∏
    const url = document.getElementById('productUrl').value.trim();
    if (url) {
        product.url = url;
    }
    
    // ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏàòÏßëÌïòÏó¨ Í∞úÎ≥Ñ ÏÉÅÌíàÏóê Ï†ÄÏû•
    const userDetails = collectUserInputDetails();
    product.userData = userDetails;
    
    // üîß Ï†ÄÏû• ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
    product.isSaved = true;
    
    // UI ÏóÖÎç∞Ïù¥Ìä∏
    updateUI();
    
    alert('üíæ ÌòÑÏû¨ ÏÉÅÌíà Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
    console.log('Ï†ÄÏû•Îêú ÏÉÅÌíà Ï†ïÎ≥¥:', product);
}

// üîß ÏàòÏ†ïÎêú ÏôÑÎ£å Í∏∞Îä• (Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º ÎåÄÍ∏∞Ïó¥Ïóê Ï†ÄÏû•) - Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ÏôÄ HTML Ìè¨Ìï®
function completeProduct() {
    console.log('‚úÖ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º ÎåÄÍ∏∞Ïó¥Ïóê Ï†ÄÏû•Ìï©ÎãàÎã§...');
    
    // 1. Í∏∞Ï°¥ ÌÇ§ÏõåÎìú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ÏôÄ HTML Ìè¨Ìï®)
    const keywordsData = collectKeywordsData();
    
    // 2. ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏàòÏßë (Îπà Í∞í Ï†úÏô∏)
    const userDetails = collectUserInputDetails();
    
    console.log('ÏàòÏßëÎêú ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥:', userDetails);
    
    // 3. Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏàòÏßë (ÌîÑÎ°¨ÌîÑÌä∏ ÌÉÄÏûÖ Ï∂îÍ∞Ä)
    const formData = {
        title: document.getElementById('title').value.trim(),
        category: document.getElementById('category').value,
        prompt_type: document.getElementById('prompt_type').value,
        keywords: keywordsData,
        user_details: userDetails // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêòÎäî ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥
    };
    
    console.log('Ï†ÑÏ≤¥ ÏàòÏßëÎêú Ï¢ÖÌï© Îç∞Ïù¥ÌÑ∞:', formData);
    
    // 4. Í≤ÄÏ¶ù Î∞è Ï†ÑÏÜ°
    if (validateAndSubmitData(formData)) {
        // validateAndSubmitData ÎÇ¥Î∂ÄÏóêÏÑú Ìèº Ï†ÑÏÜ°Ïù¥ Ïù¥Î£®Ïñ¥Ïßê
        console.log('ÎåÄÍ∏∞Ïó¥ Ï†ÄÏû• ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.');
    }
}

function previousProduct() {
    if (currentKeywordIndex === -1 || currentProductIndex === -1) return;
    
    const currentKeyword = keywords[currentKeywordIndex];
    if (currentProductIndex > 0) {
        selectProduct(currentKeywordIndex, currentProductIndex - 1);
    } else if (currentKeywordIndex > 0) {
        const prevKeyword = keywords[currentKeywordIndex - 1];
        selectProduct(currentKeywordIndex - 1, prevKeyword.products.length - 1);
    }
}

function nextProduct() {
    if (currentKeywordIndex === -1 || currentProductIndex === -1) return;
    
    const currentKeyword = keywords[currentKeywordIndex];
    if (currentProductIndex < currentKeyword.products.length - 1) {
        selectProduct(currentKeywordIndex, currentProductIndex + 1);
    } else if (currentKeywordIndex < keywords.length - 1) {
        selectProduct(currentKeywordIndex + 1, 0);
    }
}

document.getElementById('titleKeyword').addEventListener('keypress', function(e) { if (e.key === 'Enter') { e.preventDefault(); generateTitles(); } });
</script>
</body>
</html>